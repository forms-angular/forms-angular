var exec = require('child_process').exec,    _ = require('underscore'),    assert = require('assert');describe('Data API', function() {    var aData, bData;    before(function (done) {        exec('curl 0.0.0.0:3001/api/a_unadorned_mongoose',            function (error, stdout) {                if (error) {throw new Error('curl a failed')}                aData = JSON.parse(stdout);                exec('curl 0.0.0.0:3001/api/b_using_options',                    function (error, stdout) {                        if (error) {throw new Error('curl b failed')}                        bData = JSON.parse(stdout);                        done();                    });            });    });    it('should send the right number of records', function() {        assert.equal(aData.length,2);    });    it('should send the all the fields of mongoose schema', function() {        assert(aData[0].surname,'must send surname');        assert(aData[0].forename,'must send forename');        assert(aData[0].weight,'must send weight');        assert(aData[0].eyeColour,'must send eyeColour');        assert(aData[0].dateOfBirth,'must send dob');        assert.equal(aData[0].accepted,false,'must send accepted');    });    it('should filter out records that do not match the find func', function() {        assert.equal(bData.length,1);    });    it('should not send secure fields of a modified schema', function() {        assert(bData[0].surname,"Must send surname");        assert(bData[0].forename, "Must send forename");        assert.equal(Object.keys(bData[0]).indexOf('login'),-1,'Must not send secure login field');        assert.equal(Object.keys(bData[0]).indexOf('passwordHash'), -1, 'Must not send secure password hash field');        assert(bData[0].email, "Must send email");        assert(bData[0].weight, "Must send weight");        assert(bData[0].accepted, "Must send accepted");        assert(bData[0].interviewScore, 'Must send interview score');        assert(bData[0].freeText, 'Must send freetext');    });    it('should not send secure fields of a modified subschema', function() {        assert(bData[0].address.line1, "Must send line1");        assert(bData[0].address.town, "Must send town");        assert(bData[0].address.postcode, "Must send postcode");        assert.equal(Object.keys(bData[0]).indexOf('address.surveillance'), -1, 'Must not send secure surveillance field');    })});describe('Models API', function() {    var aData;    before(function (done) {        exec('curl 0.0.0.0:3001/api/models',            function (error, stdout) {                if (error) {throw new Error('curl a failed')}                aData = JSON.parse(stdout);                done();            });    });    it('should send at least two records', function() {        assert(aData.length >= 2);    });    it('should send login as a hidden field in b_using_options', function() {        assert(_.find(aData, function (resource) {            return resource.resource_name === "b_using_options";        }).options.hide.indexOf('login') > -1,'must send login as a hidden field');    });});describe('MongoDB selection API', function() {    it('Should filter', function(done) {        exec('curl 0.0.0.0:3001/api/f_nested_schema?f=%7B%22exams.subject%22:%22Maths%22%7D', function(err,stdout) {            if (err) {throw new Error('curl f with filter failed')}            var data = JSON.parse(stdout);            assert.equal(data.length,2);            done();        })    });    it('Should aggregate and return appropriate records', function(done) {        exec('curl 0.0.0.0:3001/api/f_nested_schema?a=%5B%7B%22%24unwind%22%3A%22%24exams%22%7D%2C%7B%22%24sort%22%3A%7B%22exams.score%22%3A1%7D%7D%2C%7B%22%24group%22%3A%7B%22_id%22%3A%7B%22id%22%3A%22%24_id%22%7D%2C%22bestSubject%22%3A%7B%22%24last%22%3A%22%24exams.subject%22%7D%7D%7D%2C%7B%22%24match%22%3A%7B%22bestSubject%22%3A%22English%22%7D%7D%2C%7B%22%24project%22%3A%7B%22_id%22%3A%22%24_id.id%22%7D%7D%5D', function(err,stdout) {            if (err) {throw new Error('curl f with aggregation failed')}            var data = JSON.parse(stdout);            assert.equal(data.length,2);            assert.equal(data[0].surname,'Smith');            assert.equal(data[1].surname,'Brown');            done();        })    });    it("Should combine aggregation and filtering", function(done) {        exec('curl 0.0.0.0:3001/api/f_nested_schema?f=%7B%22_id%22:%2251c583d5b5c51226db418f15%22%7D&a=%5B%7B%22%24unwind%22%3A%22%24exams%22%7D%2C%7B%22%24sort%22%3A%7B%22exams.score%22%3A1%7D%7D%2C%7B%22%24group%22%3A%7B%22_id%22%3A%7B%22id%22%3A%22%24_id%22%7D%2C%22bestSubject%22%3A%7B%22%24last%22%3A%22%24exams.subject%22%7D%7D%7D%2C%7B%22%24match%22%3A%7B%22bestSubject%22%3A%22English%22%7D%7D%2C%7B%22%24project%22%3A%7B%22_id%22%3A%22%24_id.id%22%7D%7D%5D', function(err,stdout) {            if (err) {throw new Error('curl f with aggregation and filter failed')}            var data = JSON.parse(stdout);            assert.equal(data.length,1);            assert.equal(data[0].surname,'Smith');            done();        })    })});// http://0.0.0.0:3001/#/f_nested_schema?a=%5B%7B%22$unwind%22:%22$exams%22%7D,%7B%22$sort%22:%7B%22exams.score%22:1%7D%7D,%7B%22$group%22:%7B%22_id%22:%7B%22id%22:%22$_id%22%7D,%22bestSubject%22:%7B%22$last%22:%22$exams.subject%22%7D%7D%7D,%7B%22$match%22:%7B%22bestSubject%22:%22English%22%7D%7D,%7B%22$project%22:%7B%22_id%22:%22$_id.id%22%7D%7D%5D&f=%7B%22_id%22:%2251c583d5b5c51226db418f15%22%7D