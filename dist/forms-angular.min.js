/*! forms-angular 2014-11-13 */
"use strict";var formsAngular=angular.module("formsAngular",["ngSanitize","ui.bootstrap","infinite-scroll","monospaced.elastic"]);formsAngular.controller("BaseCtrl",["$scope","$location","$filter","$modal","$window","$data","SchemasService","routingService","formGenerator","recordHandler",function(a,b,c,d,e,f,g,h,i,j){var k=f,l={master:{},fngInvalidRequired:"fng-invalid-required",allowLocationChange:!0};angular.extend(a,h.parsePathFunc()(b.$$path)),a.modelNameDisplay=k.modelNameDisplay||c("titleCase")(a.modelName),i.decorateScope(a,i,j,k),j.decorateScope(a,d,j,l),j.fillFormWithBackendSchema(a,i,j,l,j.handleError(a));for(var m=0;m<k.modelControllers.length;m++)k.modelControllers[m].onBaseCtrlReady&&k.modelControllers[m].onBaseCtrlReady(a)}]).controller("SaveChangesModalCtrl",["$scope","$modalInstance",function(a,b){a.yes=function(){b.close(!0)},a.no=function(){b.close(!1)},a.cancel=function(){b.dismiss("cancel")}}]),formsAngular.controller("ModelCtrl",["$scope","$http","$location","routingService",function(a,b,c,d){a.models=[],b.get("/api/models").success(function(b){a.models=b}).error(function(){c.path("/404")}),a.newUrl=function(a){return d.buildUrl(a+"/new")},a.listUrl=function(a){return d.buildUrl(a)}}]),formsAngular.controller("NavCtrl",["$scope","$data","$location","$filter","$controller","routingService","cssFrameworkService",function(a,b,c,d,e,f,g){function h(c,d){var f,g={};c+="Ctrl",g.$scope=b.modelControllers[d]=a.$new();try{e(c,g),f=a.routing.newRecord?"creating":a.routing.id?"editing":"listing",angular.isObject(g.$scope.contextMenu)&&angular.forEach(g.$scope.contextMenu,function(b){b[f]&&a.items.push(b)})}catch(h){/is not a function, got undefined/.test(h.message)||console.log("Unable to instantiate "+c+" - "+h.message)}}a.items=[],a.globalShortcuts=function(a){191===a.keyCode&&a.ctrlKey&&(document.querySelector("#searchinput").focus(),a.preventDefault())},a.css=function(a,b){var c;return c="function"==typeof g[a]?g[a](b):"error text-error"},a.$on("$locationChangeSuccess",function(){if(a.routing=f.parsePathFunc()(c.$$path),a.items=[],a.routing.analyse)a.contextMenu="Report",a.items=[{broadcast:"exportToPDF",text:"PDF"},{broadcast:"exportToCSV",text:"CSV"}];else if(a.routing.modelName){angular.forEach(b.modelControllers,function(a){a.$destroy()}),b.modelControllers=[],b.record={},b.disableFunctions={},b.dataEventFunctions={},delete b.dropDownDisplay,delete b.modelNameDisplay;var e=d("titleCase")(a.routing.modelName,!0);h(e,0),a.routing.formName&&h(e+d("titleCase")(a.routing.formName,!0),1),a.contextMenu=b.dropDownDisplay||b.modelNameDisplay||d("titleCase")(a.routing.modelName,!1)}}),a.doClick=function(b){if(a.items[b].broadcast)a.$broadcast(a.items[b].broadcast);else{var c=a.items[b].args||[],d=a.items[b].fn;switch(c.length){case 0:d();break;case 1:d(c[0]);break;case 2:d(c[0],c[1]);break;case 3:d(c[0],c[1],c[2]);break;case 4:d(c[0],c[1],c[2],c[3])}}},a.isHidden=function(b){return a.items[b].isHidden?a.items[b].isHidden():!1},a.buildUrl=function(a){return f.buildUrl(a)}}]),formsAngular.directive("formButtons",["cssFrameworkService",function(a){return{restrict:"A",templateUrl:"template/form-button-"+a.framework()+".html"}}]),formsAngular.directive("formInput",["$compile","$rootScope","utils","$filter","$data","routingService","cssFrameworkService","formGenerator",function(a,b,c,d,e,f,g,h){return{restrict:"EA",link:function(i,j,k){function l(a,b,d){var e="getAddAll"+a+"Options";return c[e](i,d,b)||[]}var m=[1,2,4,6,8,10,12],n=["mini","small","medium","large","xlarge","xxlarge","block-level"],o=2,p=[],q=!1,r=function(a){return!a||"undefined"===a||-1===["vertical","inline"].indexOf(a)},s=function(a,b){function c(a){var c=a;if("string"==typeof a)if("$"===a.slice(0,1)){c=(b||"record")+".";var d=a.slice(1).split(".");if(d.length>1){var e=d.pop();c+=d.join(".")+"[$index]."+e}else c+=a.slice(1)}else c="'"+a+"'";return c}var d=["eq","ne","gt","gte","lt","lte"],e=["===","!==",">",">=","<","<="],f=d.indexOf(a.comp);if(-1===f)throw new Error("Invalid comparison in showWhen");return c(a.lhs)+e[f]+c(a.rhs)},t=function(a,b,c){var d="<input "+a+'type="'+c.type+'"';return"inline"!==b.formstyle||"bs2"!==g.framework()||c.size||(d+='class="input-small"'),d+=" />"},u=function(a,b,c,d,e){var h;if(!b){var i=(e.model||"record")+".";if(b=i,e.subschema&&-1!==a.name.indexOf(".")){var j=a.name,k=e.subschemaRoot,p=j.slice(k.length+1);e.index?(b+=k+"["+e.index+"]."+p,d="f_"+b.slice(i.length).replace(/(\.|\[|\]\.)/g,"-")):(b+=k,e.subkey?(d=b.slice(i.length).replace(/\./g,"-")+"-subkey"+e.subkeyno+"-"+p,b+="[$_arrayOffset_"+k.replace(/\./g,"_")+"_"+e.subkeyno+"]."+p):(b+="[$index]."+p,d=null,h=j.replace(/\./g,"-")))}else b+=a.name}var q,s=c||a.required?" required":"",u=a.placeHolder,v="",w="",x="",y="";"bs3"===g.framework()?(v=-1===["horizontal","vertical","inline"].indexOf(e.formstyle)?" input-sm":"",w="col-sm-"+m[a.size?n.indexOf(a.size):o],y=" form-control"):x=a.size?" input-"+a.size:"","inline"===e.formstyle&&(u=u||a.label);var z='ng-model="'+b+'"'+(d?' id="'+d+'" name="'+d+'" ':' name="'+h+'" ');switch(z+=u?'placeholder="'+u+'" ':"",a.popup&&(z+='title="'+a.popup+'" '),z+=l("Field",null,e),a.type){case"select":a.select2?(z+='class="fng-select2'+y+v+x+'"',z+=a.readonly?" readonly":"",z+=a.required?' ng-required="true"':"",a.select2.fngAjax?"bs2"===g.framework()?(q='<div class="input-append">',q+='<input ui-select2="'+a.select2.fngAjax+'" '+z+">",q+='<button class="btn" type="button" data-select2-open="'+d+'" ng-click="openSelect2($event)"><i class="icon-search"></i></button>',q+="</div>"):(q='<div class="input-group">',q+='<input ui-select2="'+a.select2.fngAjax+'" '+z+">",q+='<span class="input-group-addon'+v+'" data-select2-open="'+d+'" ',q+='    ng-click="openSelect2($event)"><i class="glyphicon glyphicon-search"></i></span>',q+="</div>"):a.select2&&(q='<input ui-select2="'+a.select2.s2query+'" '+z+">")):(z+=a.readonly?"disabled ":"",q="<select "+z+'class="'+y.trim()+v+x+'" '+s+">",c||(q+="<option></option>"),angular.isArray(a.options)?angular.forEach(a.options,function(a){q+=_.isObject(a)?'<option value="'+(a.val||a.id)+'">'+(a.label||a.text)+"</option>":"<option>"+a+"</option>"}):q+='<option ng-repeat="option in '+a.options+'">{{option}}</option>',q+="</select>");break;case"link":q='<a ng-href="/'+f.buildUrl("")+a.ref+(a.form?"/"+a.form:"")+"/{{ "+b+'}}/edit">'+a.linkText+"</a>";break;case"radio":q="",z+=s+(a.readonly?" disabled ":" ");var A="inline"!==e.formstyle&&!a.inlineRadio;if(angular.isArray(a.options))e.subschema&&(z=z.replace('name="','name="{{$index}}-')),angular.forEach(a.options,function(a){q+="<input "+z+'type="radio"',q+=' value="'+a+'">'+a,A&&(q+="<br />")});else{var B=A?"div":"span";e.subschema&&(z=z.replace("$index","$parent.$index").replace('name="','name="{{$parent.$index}}-')),q+="<"+B+' ng-repeat="option in '+a.options+'"><input '+z+' type="radio" value="{{option}}"> {{option}} </'+B+"> "}break;case"checkbox":z+=s+(a.readonly?" disabled ":" "),q="bs3"===g.framework()?'<div class="checkbox"><input '+z+'type="checkbox"></div>':t(z,e,a);break;default:var C=y.trim()+v+x+(a.class?" "+a.class:"");0!==C.length&&(z+='class="'+C+'"'),a.add&&(z+=" "+a.add+" "),z+='ng-model="'+b+'"'+(d?' id="'+d+'" name="'+d+'"':"")+s+(a.readonly?" readonly":"")+" ","textarea"===a.type?(a.rows&&(z+="auto"===a.rows?'msd-elastic="\n" class="ng-animate" ':'rows = "'+a.rows+'" '),"ckEditor"===a.editor&&(z+='ckeditor = "" ',"bs3"===g.framework()&&(w="col-xs-12")),q="<textarea "+z+" />"):q=t(z,e,a)}return"bs3"===g.framework()&&r(e.formstyle)&&"checkbox"!==a.type&&(q='<div class="'+w+'">'+q+"</div>"),a.helpInline&&"checkbox"!==a.type&&(q+='<span class="help-inline">'+a.helpInline+"</span>"),a.help&&(q+='<span class="help-block '+w+'">'+a.help+"</span>"),q},v=function(a){var b;switch(a){case"horizontal":b="form-horizontal";break;case"vertical":b="";break;case"inline":b="form-inline";break;case"horizontalCompact":b="form-horizontal compact";break;default:b="form-horizontal compact"}return b},w=function(a){var b={before:"",after:""};if("function"==typeof a.containerType)b=a.containerType(a);else switch(a.containerType){case"tab":for(var c=-1,d=0;d<i.tabs.length;d++)if(i.tabs[d].title===a.title){c=d;break}c>=0?(b.before="<tab select=\"updateQueryForTab('"+a.title+'\')" heading="'+a.title+'" active="tabs['+c+'].active">',b.after="</tab>"):(b.before="<p>Error!  Tab "+a.title+" not found in tab list</p>",b.after="");break;case"tabset":b.before="<tabset>",b.after="</tabset>";break;case"well":b.before='<div class="well">',a.title&&(b.before+="<h4>"+a.title+"</h4>"),b.after="</div>";break;case"well-large":b.before='<div class="well well-lg well-large">',b.after="</div>";break;case"well-small":b.before='<div class="well well-sm well-small">',b.after="</div>";break;case"fieldset":b.before="<fieldset>",a.title&&(b.before+="<legend>"+a.title+"</legend>"),b.after="</fieldset>";break;case void 0:break;case null:break;case"":break;default:if(b.before='<div class="'+a.containerType+'">',a.title){var e=a.titleTagOrClass||"h4";b.before+=e.match(/h[1-6]/)?"<"+e+">"+a.title+"</"+e+">":'<p class="'+e+'">'+a.title+"</p>"}b.after="</div>"}return b},x=function(a,b,c){var d="";if("bs3"===g.framework()||"inline"!==c.formstyle&&""!==a.label||b){d="<label";var e="control-label";r(c.formstyle)?(d+=' for="'+a.id+'"',"undefined"!=typeof a.labelDefaultClass?e+=" "+a.labelDefaultClass:"bs3"===g.framework()&&(e+=" col-sm-2")):"inline"===c.formstyle&&(d+=' for="'+a.id+'"',e+=" sr-only"),d+=l("Label",null,c)+' class="'+e+'">'+a.label+(b||"")+"</label>"}return d},y=function(a,b){a.type=a.type||"text",a.id=a.id||"f_"+a.name.replace(/\./g,"_"),a.label=void 0!==a.label?null===a.label?"":a.label:d("titleCase")(a.name.split(".").slice(-1)[0]);var c="",e="",f="";"bs3"===g.framework()?(f="form-group","vertical"===b.formstyle&&"block-level"!==a.size&&(c+='<div class="row">',f+=" col-sm-"+m[a.size?n.indexOf(a.size):o],e+="</div>"),c+="<div"+l("Group",f,b),e+="</div>"):r(b.formstyle)?(c+="<div"+l("Group","control-group",b),e="</div>"):(c+="<span ",e="</span>");var h=!1;if(b.index)try{parseInt(b.index),h=!0}catch(j){}if(a.showWhen&&(c+="string"==typeof a.showWhen?'ng-show="'+a.showWhen+'"':'ng-show="'+s(a.showWhen,b.model)+'"'),c+=h?' id="cg_'+a.id.replace("_","-"+k.index+"-")+'">':' id="cg_'+a.id.replace(/\./g,"-")+'">',a.schema){var q=a.name.replace(/\./g,"_"),t="$_schema_"+q;if(i[t]=a.schema,a.schema)if(a.subkey){a.subkey.path=a.name,i[t+"_subkey"]=a.subkey;for(var y=angular.isArray(a.subkey)?a.subkey:[a.subkey],A=0;A<y.length;A++){var B=w(y[A]);c+=B.before,c+=z(a.schema,null,{subschema:!0,formStyle:b.formstyle,subkey:t+"_subkey",subkeyno:A,subschemaRoot:a.name}),c+=B.after}p.push(a)}else c+='<div class="schema-head">'+a.label,a.unshift&&(c+="bs2"===g.framework()?'    <button id="unshift_'+a.id+'_btn" class="add-btn btn btn-mini form-btn" ng-click="unshift(\''+a.name+'\',$event)">        <i class="icon-plus"></i> Add':'    <button id="unshift_'+a.id+'_btn" class="add-btn btn btn-default btn-xs form-btn" ng-click="unshift(\''+a.name+'\',$event)">        <i class="glyphicon glyphicon-plus"></i> Add',c+="    </button>"),c+='</div><div ng-form class="'+("bs2"===g.framework()?"row-fluid ":"")+v(a.formStyle)+'" name="form_'+q+'{{$index}}" class="sub-doc well" id="'+a.id+'List_{{$index}}"  ng-repeat="subDoc in '+(b.model||"record")+"."+a.name+' track by $index">   <div class="'+("bs2"===g.framework()?"row-fluid":"row")+' sub-doc">      <div class="pull-left">'+z(a.schema,!1,{subschema:!0,formstyle:a.formStyle,model:b.model,subschemaRoot:a.name})+"      </div>",(!a.noRemove||a.customSubDoc)&&(c+='   <div class="pull-left sub-doc-btns">',a.customSubDoc&&(c+=a.customSubDoc),a.noRemove||(c+="bs2"===g.framework()?'      <button name="remove_'+a.id+'_btn" class="remove-btn btn btn-mini form-btn" ng-click="remove(\''+a.name+'\',$index,$event)">          <i class="icon-minus">':'      <button name="remove_'+a.id+'_btn" class="remove-btn btn btn-default btn-xs form-btn" ng-click="remove(\''+a.name+'\',$index,$event)">          <i class="glyphicon glyphicon-minus">',c+="          </i> Remove      </button>"),c+="  </div> "),c+="   </div></div>",(!a.noAdd||a.customFooter)&&(c+='<div class = "schema-foot">',a.customFooter&&(c+=a.customFooter),a.noAdd||(c+="bs2"===g.framework()?'    <button id="add_'+a.id+'_btn" class="add-btn btn btn-mini form-btn" ng-click="add(\''+a.name+'\',$event)">        <i class="icon-plus"></i> Add':'    <button id="add_'+a.id+'_btn" class="add-btn btn btn-default btn-xs form-btn" ng-click="add(\''+a.name+'\',$event)">        <i class="glyphicon glyphicon-plus"></i> Add',c+="    </button>"),c+="</div>")}else{var C=[];if(r(b.formstyle)&&C.push("bs2"===g.framework()?"controls":"col-sm-10"),a.array){if(C.push("fng-array"),"inline"===b.formstyle)throw"Cannot use arrays in an inline form";var D,E;"bs2"===g.framework()?(D="icon",E=""):(D="glyphicon glyphicon",E='ng-class="skipCols($index)" '),c+=x(a,' <i id="add_'+a.id+'" ng-click="add(\''+a.name+'\',$event)" class="'+D+'-plus-sign"></i>',b)+"<div "+E+'class="'+C.join(" ")+'" id="'+a.id+'List" ng-repeat="arrayItem in '+(b.model||"record")+"."+a.name+'">'+u(a,"arrayItem.x",!0,a.id+"_{{$index}}",b)+"<i ng-click=\"remove('"+a.name+'\',$index,$event)" id="remove_'+a.id+'_{{$index}}" class="'+D+'-minus-sign"></i></div>'}else c+=x(a,null,b),C.length>0&&(c+='<div class="'+C.join(" ")+'">'),c+=u(a,null,b.required,a.id,b),C.length>0&&(c+="</div>")}return c+=e},z=function(a,b,c){var d="";if(a)for(var e=0;e<a.length;e++){var f=a[e];0===e&&b&&!c.schema.match(/$_schema_/)&&(f.add=f.add?" "+f.add+" ":"",-1!==f.add.indexOf("ui-date")||c.noautofocus||f.containerType||(f.add=f.add+"autofocus "));var g=!0;if(f.directive){for(var h=f.directive,k="<"+h+' model="'+(c.model||"record")+'"',l=j[0],m=0;m<l.attributes.length;m++){var n=l.attributes[m];switch(n.nodeName){case"class":var o=n.nodeValue.replace("ng-scope","");o.length>0&&(k+=' class="'+o+'"');break;case"schema":var p=("bespoke_"+f.name).replace(/\./g,"_");i[p]=angular.copy(f),delete i[p].directive,k+=' schema="'+p+'"';break;default:k+=" "+n.nodeName+'="'+n.nodeValue+'"'}}f.add&&(k+=" "+f.add),k+="></"+h+">",d+=k,g=!1}else if(f.containerType){var r=w(f);switch(f.containerType){case"tab":q||(q="forced",d+="<tabset>"),d+=r.before,d+=z(f.content,null,c),d+=r.after;break;case"tabset":q=!0,d+=r.before,d+=z(f.content,null,c),d+=r.after;break;default:d+=r.before,d+=z(f.content,null,c),d+=r.after}g=!1}else if(c.subkey){var s=angular.isArray(i[c.subkey])?i[c.subkey][0].keyList:i[c.subkey].keyList;_.find(s,function(a,b){return i[c.subkey].path+"."+b===f.name})&&(g=!1)}g&&(d+=y(f,c))}else console.log("Empty array passed to processInstructions"),d="";return d},A=i.$watch(k.schema,function(c){if(c&&(c=angular.isArray(c)?c:[c],c.length>0)){A();var d="",f=i[k.model||"record"];if(f=f||{},!k.subschema&&!k.model||k.forceform){i.topLevelFormName=k.name||"myForm";var g="";for(var l in k)k.hasOwnProperty(l)&&"$"!==l[0]&&-1===["name","formstyle","schema","subschema","model"].indexOf(l)&&(g+=" "+k.$attr[l]+'="'+k[l]+'"');d='<form name="'+i.topLevelFormName+'" class="'+v(k.formstyle)+' novalidate"'+g+">"}else d="";if(f===i.topLevelFormName)throw new Error("Model and Name must be distinct - they are both "+f);if(d+=z(c,!0,k),"forced"===q&&(d+="</tabset>"),d+=k.subschema?"":"</form>",j.replaceWith(a(d)(i)),p.length>0||e.modelControllers.length>0)var m=i.$watch("phase",function(a){if("ready"===a){m();for(var b=0;b<e.modelControllers.length;b++)e.modelControllers[b].onAllReady&&e.modelControllers[b].onAllReady(i);for(var c=0;c<p.length;c++){for(var d,g,h=p[c],j=angular.isArray(h.subkey)?h.subkey:[h.subkey],k=h.name.split("."),l=f;k.length>1;)l=l[k.shift()]||{};l=l[k[0]]=l[k[0]]||[];for(var n=0;n<j.length;n++){if(j[n].selectFunc){if(!i[j[n].selectFunc]||"function"!=typeof i[j[n].selectFunc])throw new Error("Subkey function "+j[n].selectFunc+" is not properly set up");d=i[j[n].selectFunc](f,h)}else{if(!j[n].keyList)throw new Error("Invalid subkey setup for "+h.name);var o=j[n].keyList;for(d=0;d<l.length;d++){g=!0;for(var q in o)if(o.hasOwnProperty(q)&&l[d][q]!==o[q]&&(!l[d][q].text||l[d][q].text!==o[q])){g=!1;break}if(g)break}g||(d=f[h.name].push(o)-1)}i["$_arrayOffset_"+h.name.replace(/\./g,"_")+"_"+n]=d}}}});b.$broadcast("formInputDone"),h.updateDataDependentDisplay&&f&&Object.keys(f).length>0&&h.updateDataDependentDisplay(f,null,!0,i)}},!0)}}}]),formsAngular.controller("SearchCtrl",["$scope","$http","$location","routingService",function(a,b,c,d){var e="";a.handleKey=function(b){if(27===b.keyCode&&a.searchTarget.length>0)a.searchTarget="";else if(a.results.length>0)switch(b.keyCode){case 38:a.focus>0&&a.setFocus(a.focus-1),"function"==typeof b.preventDefault&&b.preventDefault();break;case 40:a.results.length>a.focus+1&&a.setFocus(a.focus+1),"function"==typeof b.preventDefault&&b.preventDefault();break;case 13:null!=a.focus&&a.selectResult(a.focus)}},a.setFocus=function(b){null!==a.focus&&delete a.results[a.focus].focussed,a.results[b].focussed=!0,a.focus=b},a.selectResult=function(b){var e=a.results[b];c.path(d.prefix()+"/"+e.resource+"/"+e.id+"/edit")},a.resultClass=function(b){var c="search-result";return a.results&&a.results[b].focussed&&(c+=" focus"),c};var f=function(){a.moreCount=0,a.errorClass="",a.results=[],a.focus=null};a.$watch("searchTarget",function(c){c&&c.length>0?(e=c,b.get("/api/search?q="+c).success(function(b){e===c&&(a.searchTarget.length>0?(a.results=b.results,a.moreCount=b.moreCount,b.results.length>0&&(a.errorClass="",a.setFocus(0)),a.errorClass=0===a.results.length?"error":""):f())}).error(function(a,b){console.log("Error in searchbox.js : "+a+" (status="+b+")")})):f()},!0),a.$on("$routeChangeStart",function(){a.searchTarget=""})}]).directive("globalSearch",["cssFrameworkService",function(a){return{restrict:"AE",templateUrl:"template/search-"+a.framework()+".html",controller:"SearchCtrl"}}]),formsAngular.filter("titleCase",[function(){return function(a,b){var c=a.replace(/(_|\.)/g," ").replace(/[A-Z]/g," $&").trim().replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()});return c=b?c.replace(/\s/g,""):c.replace(/\s{2,}/g," ")}}]),formsAngular.provider("cssFrameworkService",[function(){var a={framework:"bs2"};return{setOptions:function(b){angular.extend(a,b)},$get:function(){return{framework:function(){return a.framework},span:function(b){var c;switch(a.framework){case"bs2":c="span"+b;break;case"bs3":c="col-xs-"+b}return c},offset:function(b){var c;switch(a.framework){case"bs2":c="offset"+b;break;case"bs3":c="col-lg-offset-"+b}return c},rowFluid:function(){var b;switch(a.framework){case"bs2":b="row-fluid";break;case"bs3":b="row"}return b}}}}}]),formsAngular.factory("$data",[function(){var a={record:{},disableFunctions:{},dataEventFunctions:{},modelControllers:[]};return a}]),formsAngular.provider("routingService",["$injector","$locationProvider",function(a,b){function c(a){angular.forEach(a,function(a){f.when(h.prefix+a.route,a.options||{templateUrl:a.templateUrl})})}function d(a){angular.forEach(a,function(a){g.state(a.state,a.options||{url:a.route,templateUrl:a.templateUrl})})}function e(a,b,c,d,e){var f,g=d?"/"+d:"",h=a+"/"+c;switch(b){case"list":f=h+g;break;case"edit":f=h+g+"/"+e+"/edit";break;case"new":f=h+g+"/new"}return f}var f,g,h={hashPrefix:"",html5Mode:!1,routing:"ngroute",prefix:""},i=[{route:"/analyse/:model/:reportSchemaName",state:"analyse::model::report",templateUrl:"partials/base-analysis.html"},{route:"/analyse/:model",state:"analyse::model",templateUrl:"partials/base-analysis.html"},{route:"/:model/:id/edit",state:"model::edit",templateUrl:"partials/base-edit.html"},{route:"/:model/:id/edit/:tab",state:"model::edit::tab",templateUrl:"partials/base-edit.html"},{route:"/:model/new",state:"model::new",templateUrl:"partials/base-edit.html"},{route:"/:model",state:"model::list",templateUrl:"partials/base-list.html"},{route:"/:model/:form/:id/edit",state:"model::form::edit",templateUrl:"partials/base-edit.html"},{route:"/:model/:form/:id/edit/:tab",state:"model::form::edit::tab",templateUrl:"partials/base-edit.html"},{route:"/:model/:form/new",state:"model::form::new",templateUrl:"partials/base-edit.html"},{route:"/:model/:form",state:"model::form::list",templateUrl:"partials/base-list.html"}],j=null,k={};return{start:function(e){switch(angular.extend(h,e),h.prefix[0]&&"/"!==h.prefix[0]&&(h.prefix="/"+h.prefix),b.html5Mode(h.html5Mode),""!==h.hashPrefix&&b.hashPrefix(h.hashPrefix),h.routing){case"ngroute":f=a.get("$routeProvider"),h.fixedRoutes&&c(h.fixedRoutes),c(i);break;case"uirouter":g=a.get("$stateProvider"),h.fixedRoutes&&d(h.fixedRoutes),setTimeout(function(){d(i)})}},$get:function(){return{router:function(){return h.routing},prefix:function(){return h.prefix},parsePathFunc:function(){return function(a){if(a!==j){j=a,k={newRecord:!1},h.prefix.length>0&&0===a.indexOf(h.prefix)&&(a=a.slice(h.prefix.length));var b=a.split("/"),c=b.length;if("analyse"===b[1])k.analyse=!0,k.modelName=b[2],k.reportSchemaName=c>=4?b[3]:null;else{k.modelName=b[1];var d,e=[b[c-1],b[c-2]],f=e.indexOf("new");-1===f?(d=e.indexOf("edit"),-1!==d&&(c-=2+d,k.id=b[c])):(k.newRecord=!0,c-=1+f),(1===d||1===f)&&(k.tab=e[0]),c>2&&(k.formName=b[2])}}return k}},buildUrl:function(a){var b=h.html5Mode?"":"#";return b+=h.hashPrefix,b+=h.prefix,b[0]&&(b+="/"),b+="/"===a[0]?a.slice(1):a},buildOperationUrl:function(a,b,c,d){return e(h.prefix,a,b,c,d)},redirectTo:function(){return function(a,b,c,d){c.search()&&c.url(c.path());var f=e(h.prefix,a,b.modelName,b.formName,d);c.path(f)}}}}}}]),formsAngular.factory("formGenerator",function(a,b,c,d,e){function f(a,b,c,d){var e="#"+(c?"cg_":"")+b,f=angular.element(document.querySelector(e));a?f.removeClass(d.fngInvalidRequired):f.addClass(d.fngInvalidRequired)}function g(a,b){for(var c=a.split("."),d=b.record,e=0,f=c.length;f>e;e++)d[c[e]]||(d[c[e]]=e===f-1?[]:{}),d=d[c[e]];return d}var h={};h.generateEditUrl=function(a,b){return d.buildUrl(b.modelName+"/"+(b.formName?b.formName+"/":"")+a._id+"/edit")},h.generateNewUrl=function(a){return d.buildUrl(a.modelName+"/"+(a.formName?a.formName+"/":"")+"new")},h.handleSchema=function(a,b,c,d,e,f,g,l,n){function o(a,b){var c=angular.copy(a),d=_.find(g.tabs,function(a){return a.title===c});if(!d){if(0===g.tabs.length&&g.formSchema.length>0){g.tabs.push({title:"Main",content:[],active:"Main"===g.tab||!g.tab}),d=g.tabs[0];for(var e=0;e<g.formSchema.length;e++)d.content.push(g.formSchema[e])}d=g.tabs[g.tabs.push({title:c,containerType:"tab",content:[],active:c===g.tab})-1]}d.content.push(b)}for(var p in b)if("_id"!==p&&b.hasOwnProperty(p)){var q=b[p],r=q.options||{},s=r.form||{};if(!s.hidden)if(q.schema){if(f&&c){var t=[];h.handleSchema("Nested "+p,q.schema,t,null,p+".",!0,g,l,n);var u=i(p,s,e);u.schema=t,s.tab&&o(s.tab,u),void 0!==s.order?c.splice(s.order,0,u):c.push(u)}}else{if(c){var v=i(p,s,e);if(m(v.showIf,v.name,g)&&"options"!==p){var w=h.handleFieldType(v,q,r,g,l,n);w.tab&&o(w.tab,w),void 0!==s.order?c.splice(s.order,0,w):c.push(w)}}d&&j(d,r.list,p)}}d&&0===d.length&&k(a,d,c,b)},h.handleFieldType=function(d,g,i,j,k,l){var m;if(g.caster&&(d.array=!0,g=g.caster,angular.extend(i,g.options)),"String"===g.instance)i.enum?(d.type=d.type||"select",d.select2?(i.required&&(j.$watch("record."+d.name,function(a){f(a,d.id,d.select2,k)},!0),setTimeout(function(){f(j.record[d.name],d.id,d.select2,k)},0)),d.select2===!0&&(d.select2={}),d.select2.s2query="select2"+d.name.replace(/\./g,"_"),j[d.select2.s2query]={allowClear:!i.required,initSelection:function(a,c){function e(){function g(b,c,d){if(c)if(0===b.length)d(c);else{if(angular.isArray(c)){var e=a.context.getAttribute("ng-model"),f=e.indexOf("."+b[0]);e=e.slice(0,f),f=e.lastIndexOf("."),e=e.slice(f+1),e=/.+\[(.+)\]/.exec(e),c=c[j[e[1]]]}c=c[b.shift()],g(b,c,d)}}var h=j.record;if(h){var i=d.name.split(".");g(i,h,function(b){if(setTimeout(f(b,d.id,d.select2,k)),b)if(d.array){var e=parseInt(a.context.id.match("_[0-9].*$")[0].slice(1));b[e].x&&c(b[e].x)}else c(b)})}else b(e)}b(e)},query:function(a){for(var b={results:[]},c=a.term.toUpperCase(),d=0;d<i.enum.length;d++)-1!==i.enum[d].toUpperCase().indexOf(c)&&b.results.push({id:d,text:i.enum[d]});a.callback(b)}},_.extend(j[d.select2.s2query],d.select2),d.select2===!0&&(d.select2={}),j.select2List.push(d.name)):(d.options=e.suffixCleanId(d,"Options"),j[d.options]=i.enum)):(d.type||(d.type=-1!==d.name.toLowerCase().indexOf("password")?"password":"text"),i.match&&(d.add='pattern="'+i.match+'" '+(d.add||"")));else if("ObjectID"===g.instance)d.ref=i.ref,d.link&&d.link.linkOnly?(d.type="link",d.linkText=d.link.text,d.form=d.link.form,delete d.link):(d.type="select",d.select2||i.form&&i.form.select2?(d.select2||(d.select2=i.form.select2),d.select2===!0&&(d.select2={}),j.select2List.push(d.name),d.select2.fngAjax?(m="ajax"+d.name.replace(/\./g,""),i.required||d.placeHolder||(d.placeHolder="Select..."),j[m]={allowClear:!i.required,minimumInputLength:2,initSelection:function(b,f){var g=b.val();g&&""!==g&&c.getListAttributes(i.ref,g).success(function(c){c.success===!1&&a.path("/404");var h={id:g,text:c.list};e.setData(k.master,d.name,b,h);var i=b.inheritedData("$ngModelController"),j=i.$pristine;j&&(i.$pristine=!1),f(h),j&&(i.$pristine=!0)}).error(l)},ajax:{url:"/api/search/"+i.ref,data:function(a,b){var c,d={q:a,pageLimit:10,page:b};return"object"==typeof i.form.searchQuery?c=i.form.searchQuery:"function"==typeof i.form.searchQuery&&(c=i.form.searchQuery(j,i)),c&&_.extend(d,c),d},results:function(a){return{results:a.results,more:a.moreCount>0}}}},_.extend(j[m],d.select2),d.select2.fngAjax=m):(d.select2===!0&&(d.select2={}),d.select2.s2query="select2"+d.name.replace(/\./g,"_"),j["select2"+d.select2.s2query]={allowClear:!i.required,initSelection:function(a,b){var c=a.val();if(""!==c&&j[d.ids].length>0){var f=e.convertIdToListValue(c,j[d.ids],j[d.options],d.name),g={id:c,text:f};b(g)}},query:function(a){for(var b={results:[]},c=a.term.toUpperCase(),e=0;e<j[d.options].length;e++)-1!==j[d.options][e].toUpperCase().indexOf(c)&&b.results.push({id:j[d.ids][e],text:j[d.options][e]});a.callback(b)}},_.extend(j[d.select2.s2query],d.select2),j.select2List.push(d.name),d.options=e.suffixCleanId(d,"Options"),d.ids=e.suffixCleanId(d,"_ids"),e.setUpSelectOptions(i.ref,d,j,k,h.handleSchema,l))):(d.options=e.suffixCleanId(d,"Options"),d.ids=e.suffixCleanId(d,"_ids"),e.setUpSelectOptions(i.ref,d,j,k,h.handleSchema,l)));else if("Date"===g.instance)d.type||(d.readonly?d.type="text":(d.type="text",d.add="ui-date ui-date-format "));else if("boolean"===g.instance)d.type="checkbox";else{if("Number"!==g.instance)throw new Error("Field "+d.name+" is of unsupported type "+g.instance);d.type="number",i.min&&(d.add='min="'+i.min+'" '+(d.add||"")),i.max&&(d.add='max="'+i.max+'" '+(d.add||"")),d.step&&(d.add='step="'+d.step+'" '+(d.add||""))}return i.required&&(d.required=!0),i.readonly&&(d.readonly=!0),d};var i=function(a,b,c){return b.name=c+a,b},j=function(a,b,c){var d=b||{hidden:!0};d.hidden||("object"==typeof d?(d.name=c,a.push(d)):a.push({name:c}))},k=function(a,b,c,d){if(c){for(var e=0,f=c.length;f>e;e++)if("text"===c[e].type){b.push({name:c[e].name});break}0===b.length&&0!==c.length&&b.push({name:c[0].name})}if(0===b.length){for(var g in d)if("_id"!==g&&d.hasOwnProperty(g)){b.push({name:g});break}if(0===b.length)throw new Error("Unable to generate a title for "+a)}},l=function(a,b,c){function d(a){var d=a;if("string"==typeof a&&"$"===a.slice(0,1)){var f=a.split(".");switch(f.length){case 1:d=e.getListData(b,a.slice(1),c);break;case 2:d=e.getListData(b,f[1],c);break;default:throw new Error("Unsupported showIf format")}}return d}var f,g=d(a.lhs),h=d(a.rhs);switch(a.comp){case"eq":f=g===h;break;case"ne":f=g!==h;break;default:throw new Error("Unsupported comparator "+a.comp)}return f},m=function(a,b,c){function d(a){if("string"==typeof a&&"$"===a.slice(0,1)){var d=a.slice(1),f=c.dataDependencies[d]||[];f.push(b),c.dataDependencies[d]=f,e+=1}}var e=0,f=!0;return a&&(d(a.lhs),d(a.rhs),0!==e||l(a,void 0,c.select2List)||(f=!1)),f};return h.updateDataDependentDisplay=function(a,b,c,d){var e,f,g,h,i,j;for(var k in d.dataDependencies)if(d.dataDependencies.hasOwnProperty(k)){var m=k.split(".");if(1===m.length){if(c||!b||a[k]!==b[k])for(e=d.dataDependencies[k],f=0;f<e.length;f+=1){var n=e[f];for(g=0;g<d.formSchema.length;g+=1)d.formSchema[g].name===n&&(i=angular.element(document.querySelector("#cg_"+d.formSchema[g].id)),l(d.formSchema[g].showIf,a,d.select2List)?i.removeClass("ng-hide"):i.addClass("ng-hide"))}}else{if(2!==m.length)throw new Error("You can only go down one level of subdocument with showIf");if(void 0===j&&(j=!0),a[m[0]])for(h=0;h<a[m[0]].length;h++)if(c||!b||!b[m[0]]||!b[m[0]][h]||a[m[0]][h][m[1]]!==b[m[0]][h][m[1]])for(e=d.dataDependencies[k],f=0;f<e.length;f+=1){var o=e[f].split(".");if(2!==o.length)throw new Error("Conditional display must control dependent fields at same level ");for(g=0;g<d.formSchema.length;g+=1)if(d.formSchema[g].name===o[0])for(var p=d.formSchema[g].schema,q=0;q<p.length;q++)p[q].name===e[f]&&(i=angular.element(document.querySelector("#f_"+o[0]+"List_"+h+" #cg_f_"+e[f].replace(".","_"))),0===i.length?i=angular.element(document.querySelector("#f_elements-"+h+"-"+o[1])):j=!1,i.length>0&&(l(d.formSchema[g].schema[q].showIf,a[m[0]][h],d.select2List)?i.show():i.hide()))}}}return j},h.add=function(a,b,c){var d=g(a,c);d.push({}),c.setFormDirty(b)},h.unshift=function(a,b,c){var d=g(a,c);d.unshift({}),c.setFormDirty(b)},h.remove=function(a,b,c,d){for(var e=a.split("."),f=d.record,g=0,h=e.length;h>g;g++)f=f[e[g]];f.splice(b,1),d.setFormDirty(c)},h.decorateScope=function(a,b,c,d){a.record=d.record,a.phase="init",a.disableFunctions=d.disableFunctions,a.dataEventFunctions=d.dataEventFunctions,a.topLevelFormName=void 0,a.formSchema=[],a.tabs=[],a.listSchema=[],a.recordList=[],a.dataDependencies={},a.select2List=[],a.pageSize=60,a.pagesLoaded=0,d.baseScope=a,a.generateEditUrl=function(c){return b.generateEditUrl(c,a)},a.generateNewUrl=function(){return b.generateNewUrl(a)},a.scrollTheList=function(){return c.scrollTheList(a,c.handleError(a))},a.getListData=function(b,d){return c.getListData(b,d,a.select2List)},a.setPristine=function(){a.dismissError(),a[a.topLevelFormName]&&a[a.topLevelFormName].$setPristine()},a.skipCols=function(a){return a>0?"col-md-offset-2":""},a.setFormDirty=function(a){if(a){var b=angular.element(a.target).inheritedData("$formController");b.$setDirty()}else console.log("setFormDirty called without an event (fine in a unit test)")},a.add=function(c,d){return b.add(c,d,a)},a.unshift=function(c,d){return b.unshift(c,d,a)},a.remove=function(c,d,e){return b.remove(c,d,e,a)},a.openSelect2=function(a){$("#"+$(a.currentTarget).data("select2-open")).select2("open")},a.toJSON=function(a){return JSON.stringify(a,null,2)},a.baseSchema=function(){return a.tabs.length?a.tabs:a.formSchema}},h}),formsAngular.factory("recordHandler",function(a,b,c,d,e,f){function g(a){var b=a.split("."),c=[b[0]];return b.length>1&&c.push(b.slice(1).join(".")),c}function h(a,b,c){var d=g(a);if(d.length>1)i(d[1],b[d[0]],c);else if(b[d[0]]){var e=b[d[0]];if(angular.isArray(e))for(var f=e.length-1;f>=0;f--){var h=typeof e[f];("undefined"===h||"object"===h&&0===Object.keys(e[f]).length)&&e.splice(f,1)}b[d[0]]=c(e)}}function i(a,b,c){if(void 0!==b)if(angular.isArray(b))for(var d=0;d<b.length;d++)h(a,b[d],c);else h(a,b,c)}function j(a,b,c,d){if(a.array){for(var e=[],f=0;f<b.length;f++)e.push({x:l.convertIdToListValue(b[f],d,c,a.name)});return e}return a.select2?{id:b,text:l.convertIdToListValue(b,d,c,a.name)}:l.convertIdToListValue(b,d,c,a.name)}function k(a,b,c,d){if(a.array){for(var e=[],f=0;f<b.length;f++)e.push(r(b[f],c,d,a.name));return e}return r(b,c,d,a.name)}var l={};l.processServerData=function(a,b,c){c.master=q(b.formSchema,a,0,b),b.phase="ready",b.cancel()},l.readRecord=function(b,c,d){e.readRecord(b.modelName,b.id).success(function(d){d.success===!1&&a.path("/404"),c.allowLocationChange=!1,b.phase="reading","function"==typeof b.dataEventFunctions.onAfterRead&&b.dataEventFunctions.onAfterRead(d),l.processServerData(d,b,c)
}).error(d)},l.scrollTheList=function(b,c){e.getPagedAndFilteredList(b.modelName,{aggregate:a.$$search.a,find:a.$$search.f,limit:b.pageSize,skip:b.pagesLoaded*b.pageSize,order:a.$$search.o}).success(function(a){angular.isArray(a)?(b.pagesLoaded++,b.recordList=b.recordList.concat(a)):b.showError(a,"Invalid query")}).error(c)},l.deleteRecord=function(b,c,f,g){e.deleteRecord(b,c).success(function(){"function"==typeof f.dataEventFunctions.onAfterDelete&&f.dataEventFunctions.onAfterDelete(g.master),d.redirectTo()("list",f,a)})},l.updateDocument=function(a,c,d,f,g){d.phase="updating",e.updateRecord(d.modelName,d.id,a).success(function(a){a.success!==!1?("function"==typeof d.dataEventFunctions.onAfterUpdate&&d.dataEventFunctions.onAfterUpdate(a,g.master),c.redirect?(c.allowChange&&(g.allowLocationChange=!0),b.location=c.redirect):(l.processServerData(a,d,g),d.setPristine())):d.showError(a)}).error(f)},l.createNew=function(c,f,g,h){e.createRecord(g.modelName,c).success(function(c){c.success!==!1?("function"==typeof g.dataEventFunctions.onAfterCreate&&g.dataEventFunctions.onAfterCreate(c),f.redirect?b.location=f.redirect:d.redirectTo()("edit",g,a,c._id)):g.showError(c)}).error(h)},l.getListData=function(a,b,c){for(var d=b.split("."),e=0;e<d.length;e++)void 0!==a&&(a=a[d[e]]);return a&&-1!==c.indexOf(d[e-1])&&(a=a.text||a),void 0===a&&(a=""),a};var m=function(a,b,c){for(var d=b.split("."),e=d.length-1,f=a,g=0;e>g&&(f=angular.isArray(f)?_.map(f,function(a){return a[d[g]]}):f[d[g]],angular.isArray(f)&&c&&c.scope&&"function"==typeof c.scope&&(f=f[c.scope().$index]),f);g++);return{lastObject:f,key:f?d[e]:void 0}};l.suffixCleanId=function(a,b){return(a.id||"f_"+a.name).replace(/\./g,"_")+b};var n=function(a,b,c){var d,e=m(a,b,c);return e.lastObject&&e.key&&(d=angular.isArray(e.lastObject)?_.map(e.lastObject,function(a){return a[e.key]}):e.lastObject[e.key]),d};l.setData=function(a,b,c,d){var e=m(a,b,c);if(e.lastObject&&e.key)if(angular.isArray(e.lastObject))for(var f=0;f<e.lastObject.length;f++)e.lastObject[f][e.key]=d[f];else e.lastObject[e.key]=d};var o=function(a,b,c){if(!b.topLevelFormName||b[b.topLevelFormName].$pristine){h(a.name,c.master,function(c){return j(a,c,b[l.suffixCleanId(a,"Options")],b[l.suffixCleanId(a,"_ids")])});var d=n(c.master,a.name);d&&l.setData(b.record,a.name,void 0,d)}};l.setUpSelectOptions=function(a,b,c,d,g,h){var i=c[b.options]=[],j=c[b.ids]=[];f.getSchema(a).success(function(f){var k=[];g("Lookup "+a,f,null,k,"",!1,c,d,h);var l;"undefined"!=typeof b.filter&&b.filter?(console.log("filtering"),l=e.getPagedAndFilteredList(a,b.filter)):l=e.getAll(a),l.success(function(a){if(a){for(var e=0;e<a.length;e++){for(var f="",g=0;g<k.length;g++)f+=a[e][k[g].name]+" ";f=f.trim();var h=_.sortedIndex(i,f);i[h]===f&&(f=f+"    ("+a[e]._id+")",h=_.sortedIndex(i,f)),i.splice(h,0,f),j.splice(h,0,a[e]._id)}o(b,c,d)}})})};var p=function(a){var b=!1;return"text"===a.type?b=!0:"select"!==a.type||a.ids||(b=!0),b},q=function(a,b,c,d){for(var e=0;e<a.length;e++){var f=a[e].name.slice(c);if(a[e].schema){var g=n(b,f);if(g)for(var h=0;h<g.length;h++)g[h]=q(a[e].schema,g[h],c+1+f.length,d)}else{var i=l.getListData(b,f,d.select2List);if(a[e].array&&p(a[e])&&i)for(var k=0;k<i.length;k++)i[k]={x:i[k]};var m=d[l.suffixCleanId(a[e],"_ids")];if(m&&m.length>0&&b[f])b[f]=j(a[e],b[f],d[l.suffixCleanId(a[e],"Options")],m);else if(a[e].select2&&!a[e].select2.fngAjax&&b[f])if(a[e].array)for(var o=0;o<b[f].length;o++)d[a[e].select2.s2query].query({term:b[f][o].x.text||b[f][o].text||b[f][o].x||b[f][o],callback:function(a){a.results.length>0&&(b[f][o].x?b[f][o].x=a.results[0]:b[f][o]=a.results[0])}});else d[a[e].select2.s2query].query({term:b[f],callback:function(a){a.results.length>0&&(b[f]=a.results[0])}})}}return b};l.convertToMongoModel=function(a,b,c,d){function e(a,b){var c;return b.select2.fngAjax?a&&a.id&&(c=a.id):a&&(c=a.text||a.x.text),c}for(var f=0;f<a.length;f++){var g=a[f].name.slice(c),i=l.getListData(b,g,d.select2List);if(a[f].schema){if(i)for(var j=0;j<i.length;j++)i[j]=l.convertToMongoModel(a[f].schema,i[j],c+1+g.length,d)}else{if(a[f].array&&p(a[f])&&i)for(var m=0;m<i.length;m++)i[m]=i[m].x;var o=d[l.suffixCleanId(a[f],"_ids")];if(o&&o.length>0)h(g,b,function(b){return k(a[f],b,d[l.suffixCleanId(a[f],"Options")],o)});else if(a[f].select2){var q,r=n(b,g,null);if(a[f].array){if(q=[],r)for(var s=0;s<r.length;s++)q[s]=e(r[s],a[f])}else q=e(r,a[f]);l.setData(b,g,null,q)}}}return b},l.convertIdToListValue=function(a,b,c,d){var e=b.indexOf(a);if(-1===e)throw new Error("convertIdToListValue: Invalid data - id "+a+" not found in "+b+" processing "+d);return c[e]};var r=function(a,b,c,d){var e=_.isObject(a)?a.x||a.text:a;if(e&&e.match(/^[0-9a-f]{24}$/))return e;var f=b.indexOf(e);if(-1===f)throw new Error("convertListValueToId: Invalid data - value "+e+" not found in "+b+" processing "+d);return c[f]};return l.handleError=function(a){return function(b,d){if(-1!==[200,400].indexOf(d)){var e="";for(var f in b.errors)if(b.errors.hasOwnProperty(f)){switch(e+="<li><b>"+c("titleCase")(f)+": </b> ",b.errors[f].type){case"enum":e+="You need to select from the list of values";break;default:e+=b.errors[f].message}e+="</li>"}e=e.length>0?b.message+"<br /><ul>"+e+"</ul>":b.message||"Error!  Sorry - No further details available.",a.showError(e)}else a.showError(d+" "+JSON.stringify(b))}},l.decorateScope=function(c,e,f,g){c.cancel=function(){angular.copy(g.master,c.record),c.setPristine()};var h=l.handleError(c);c.$on("showErrorMessage",function(a,b){c.showError(b.body,b.title)}),c.showError=function(a,b){c.alertTitle=b?b:"Error!",c.errorMessage=a},c.dismissError=function(){delete c.errorMessage},c.save=function(a){a=a||{};var b=f.convertToMongoModel(c.formSchema,angular.copy(c.record),0,c);c.id?"function"==typeof c.dataEventFunctions.onBeforeUpdate?c.dataEventFunctions.onBeforeUpdate(b,g.master,function(d){d?c.showError(d):f.updateDocument(b,a,c,h,g)}):f.updateDocument(b,a,c,h,g):"function"==typeof c.dataEventFunctions.onBeforeCreate?c.dataEventFunctions.onBeforeCreate(b,function(d){d?c.showError(d):f.createNew(b,a,c,h)}):f.createNew(b,a,c,h)},c.newClick=function(){d.redirectTo()("new",c,a)},c.$on("$locationChangeStart",function(a,d){if(!g.allowLocationChange&&!c.isCancelDisabled()){a.preventDefault();var f=e.open({template:'<div class="modal-header">   <h3>Record modified</h3></div><div class="modal-body">   <p>Would you like to save your changes?</p></div><div class="modal-footer">    <button class="btn btn-primary dlg-yes" ng-click="yes()">Yes</button>    <button class="btn btn-warning dlg-no" ng-click="no()">No</button>    <button class="btn dlg-cancel" ng-click="cancel()">Cancel</button></div>',controller:"SaveChangesModalCtrl",backdrop:"static"});f.result.then(function(a){a?c.save({redirect:d,allowChange:!0}):(g.allowLocationChange=!0,b.location=d)})}}),c.deleteClick=function(){if(c.record._id){var a=e.open({template:'<div class="modal-header">   <h3>Delete Item</h3></div><div class="modal-body">   <p>Are you sure you want to delete this record?</p></div><div class="modal-footer">    <button class="btn btn-primary dlg-no" ng-click="cancel()">No</button>    <button class="btn btn-warning dlg-yes" ng-click="yes()">Yes</button></div>',controller:"SaveChangesModalCtrl",backdrop:"static"});a.result.then(function(a){a&&("function"==typeof c.dataEventFunctions.onBeforeDelete?c.dataEventFunctions.onBeforeDelete(g.master,function(a){a?c.showError(a):f.deleteRecord(c.modelName,c.id,c,g)}):f.deleteRecord(c.modelName,c.id,c,g))})}},c.isCancelDisabled=function(){return"function"==typeof c.disableFunctions.isCancelDisabled?c.disableFunctions.isCancelDisabled(c.record,g.master,c[c.topLevelFormName]):c[c.topLevelFormName]&&c[c.topLevelFormName].$pristine},c.isSaveDisabled=function(){return"function"==typeof c.disableFunctions.isSaveDisabled?c.disableFunctions.isSaveDisabled(c.record,g.master,c[c.topLevelFormName]):c[c.topLevelFormName]&&(c[c.topLevelFormName].$invalid||c[c.topLevelFormName].$pristine)},c.isDeleteDisabled=function(){return"function"==typeof c.disableFunctions.isDeleteDisabled?c.disableFunctions.isDeleteDisabled(c.record,g.master,c[c.topLevelFormName]):!c.id},c.isNewDisabled=function(){return"function"==typeof c.disableFunctions.isNewDisabled?c.disableFunctions.isNewDisabled(c.record,g.master,c[c.topLevelFormName]):!1},c.disabledText=function(a){var b="";return c.isSaveDisabled&&(b="This button is only enabled when the form is complete and valid.  Make sure all required inputs are filled in. "+a),b}},l.fillFormFromBackendCustomSchema=function(a,b,c,d,e,f){var g=!b.id&&!b.newRecord;if(c.handleSchema("Main "+b.modelName,a,g?null:b.formSchema,b.listSchema,"",!0,b,e,f),g)e.allowLocationChange=!0;else{var h=!0;b.$watch("record",function(a,d){a!==d&&(h=c.updateDataDependentDisplay(a,d,h,b))},!0),b.id?"function"==typeof b.dataEventFunctions.onBeforeRead?b.dataEventFunctions.onBeforeRead(b.id,function(a){a?b.showError(a):d.readRecord(b,e,f)}):d.readRecord(b,e,f):(e.master={},b.phase="ready",b.cancel())}},l.fillFormWithBackendSchema=function(a,b,c,d,e){f.getSchema(a.modelName,a.formName).success(function(f){l.fillFormFromBackendCustomSchema(f,a,b,c,d,e)}).error(e)},l}),formsAngular.factory("SchemasService",["$http",function(a){return{getSchema:function(b,c){return a.get("/api/schema/"+b+(c?"/"+c:""),{cache:!0})}}}]),formsAngular.factory("SubmissionsService",["$http",function(a){var b=function(a){var b="",c=function(a,c){c&&""!==c&&("object"==typeof c&&(c=JSON.stringify(c)),""===b?b="?":b+="&",b+=a+"="+c)};return c("l",a.limit),c("f",a.find),c("a",a.aggregate),c("o",a.order),c("s",a.skip),b};return{getListAttributes:function(b,c){return a.get("/api/"+b+"/"+c+"/list")},readRecord:function(b,c){return a.get("/api/"+b+"/"+c)},getAll:function(b){return a.get("/api/"+b,{cache:!0})},getPagedAndFilteredList:function(c,d){return a.get("/api/"+c+b(d))},deleteRecord:function(b,c){return a.delete("/api/"+b+"/"+c)},updateRecord:function(b,c,d){return a.post("/api/"+b+"/"+c,d)},createRecord:function(b,c){return a.post("/api/"+b,c)}}}]),formsAngular.service("utils",function(){function a(a,b,c,d){function e(a){for(var b in a)b===c&&i.push(a[b]),"$parent"===b&&e(a[b])}var f,g,h,i=[],j=[];if(c="addAll"+c,"string"==typeof d)for(f=d.split(" "),g=0;g<f.length;g++)j.push(f[g]);if(e(a),void 0!==b[c])if("object"==typeof b[c]);else if("string"==typeof b[c])for(f=b[c].split(" "),g=0;g<f.length;g++)0===f[g].indexOf("class=")?j.push(f[g].substring(6,f[g].length)):i.push(f[g]);return d=j.length>0?' class="'+j.join(" ")+'" ':" ",h=i.length>0?i.join(" ")+" ":"",d+h}this.getAddAllGroupOptions=function(b,c,d){return a(b,c,"Group",d)},this.getAddAllFieldOptions=function(b,c,d){return a(b,c,"Field",d)},this.getAddAllLabelOptions=function(b,c,d){return a(b,c,"Label",d)}}),angular.module("formsAngular").run(["$templateCache",function(a){a.put("template/form-button-bs2.html",'<div class="btn-group pull-right"><button id=saveButton class="btn btn-mini btn-primary form-btn" ng-click=save() ng-disabled=isSaveDisabled()><i class=icon-ok></i> Save</button> <button id=cancelButton class="btn btn-mini btn-warning form-btn" ng-click=cancel() ng-disabled=isCancelDisabled()><i class=icon-remove></i> Cancel</button></div><div class="btn-group pull-right"><button id=newButton class="btn btn-mini btn-success form-btn" ng-click=newClick() ng-disabled=isNewDisabled()><i class=icon-plus></i> New</button> <button id=deleteButton class="btn btn-mini btn-danger form-btn" ng-click=deleteClick() ng-disabled=isDeleteDisabled()><i class=icon-minus></i> Delete</button></div>'),a.put("template/form-button-bs3.html",'<div class="btn-group pull-right"><button id=saveButton class="btn btn-primary form-btn btn-xs" ng-click=save() ng-disabled=isSaveDisabled()><i class="glyphicon glyphicon-ok"></i> Save</button> <button id=cancelButton class="btn btn-warning form-btn btn-xs" ng-click=cancel() ng-disabled=isCancelDisabled()><i class="glyphicon glyphicon-remove"></i> Cancel</button></div><div class="btn-group pull-right"><button id=newButton class="btn btn-success form-btn btn-xs" ng-click=newClick() ng-disabled=isNewDisabled()><i class="glyphicon glyphicon-plus"></i> New</button> <button id=deleteButton class="btn btn-danger form-btn btn-xs" ng-click=deleteClick() ng-disabled=isDeleteDisabled()><i class="glyphicon glyphicon-minus"></i> Delete</button></div>'),a.put("template/search-bs2.html",'<form class="navbar-search pull-right"><div id=search-cg class=control-group ng-class=errorClass><input id=searchinput ng-model=searchTarget class=search-query placeholder="Ctrl+Slash to Search" ng-keyup=handleKey($event)></div></form><div class=results-container ng-show="results.length >= 1"><div class=search-results><div ng-repeat="result in results"><span ng-class=resultClass($index) ng-click=selectResult($index)>{{result.resourceText}} {{result.text}}</span></div><div ng-show="moreCount > 0">(plus more - continue typing to narrow down search...)</div></div></div>'),a.put("template/search-bs3.html",'<form class="pull-right navbar-form"><div id=search-cg class=form-group ng-class=errorClass><input id=searchinput ng-model=searchTarget class="search-query form-control" placeholder="Ctrl+Slash to Search" ng-keyup=handleKey($event)></div></form><div class=results-container ng-show="results.length >= 1"><div class=search-results><div ng-repeat="result in results"><span ng-class=resultClass($index) ng-click=selectResult($index)>{{result.resourceText}} {{result.text}}</span></div><div ng-show="moreCount > 0">(plus more - continue typing to narrow down search...)</div></div></div>')}]);