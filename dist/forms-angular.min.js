/*! forms-angular 2015-03-12 */
"use strict";var formsAngular=angular.module("formsAngular",["ngSanitize","ui.bootstrap","infinite-scroll","monospaced.elastic"]);formsAngular.controller("BaseCtrl",["$scope","$rootScope","$location","$filter","$modal","$window","$data","SchemasService","routingService","formGenerator","recordHandler",function(a,b,c,d,e,f,g,h,i,j,k){var l=g,m={master:{},fngInvalidRequired:"fng-invalid-required",allowLocationChange:!0};angular.extend(a,i.parsePathFunc()(c.$$path)),a.modelNameDisplay=l.modelNameDisplay||d("titleCase")(a.modelName),b.$broadcast("fngFormLoadStart",a),j.decorateScope(a,j,k,l),k.decorateScope(a,e,k,m),k.fillFormWithBackendSchema(a,j,k,m,k.handleError(a));for(var n=0;n<l.modelControllers.length;n++)l.modelControllers[n].onBaseCtrlReady&&l.modelControllers[n].onBaseCtrlReady(a)}]).controller("SaveChangesModalCtrl",["$scope","$modalInstance",function(a,b){a.yes=function(){b.close(!0)},a.no=function(){b.close(!1)},a.cancel=function(){b.dismiss("cancel")}}]),formsAngular.controller("ModelCtrl",["$scope","$http","$location","routingService",function(a,b,c,d){a.models=[],b.get("/api/models").success(function(b){a.models=b}).error(function(){c.path("/404")}),a.newUrl=function(a){return d.buildUrl(a+"/new")},a.listUrl=function(a){return d.buildUrl(a)}}]),formsAngular.controller("NavCtrl",["$scope","$data","$location","$filter","$controller","routingService","cssFrameworkService",function(a,b,c,d,e,f,g){function h(c,d){var f,g={};c+="Ctrl",g.$scope=b.modelControllers[d]=a.$new();try{e(c,g),f=a.routing.newRecord?"creating":a.routing.id?"editing":"listing",angular.isObject(g.$scope.contextMenu)&&angular.forEach(g.$scope.contextMenu,function(b){b[f]&&a.items.push(b)})}catch(h){/is not a function, got undefined/.test(h.message)||console.log("Unable to instantiate "+c+" - "+h.message)}}a.items=[],a.isCollapsed=!0,a.globalShortcuts=function(a){191===a.keyCode&&a.ctrlKey&&(document.querySelector("#searchinput").focus(),a.preventDefault())},a.css=function(a,b){var c;return c="function"==typeof g[a]?g[a](b):"error text-error"},a.$on("$locationChangeSuccess",function(){if(a.routing=f.parsePathFunc()(c.$$path),a.items=[],a.routing.analyse)a.contextMenu="Report",a.items=[{broadcast:"exportToPDF",text:"PDF"},{broadcast:"exportToCSV",text:"CSV"}];else if(a.routing.modelName){angular.forEach(b.modelControllers,function(a){a.$destroy()}),b.modelControllers=[],b.record={},b.disableFunctions={},b.dataEventFunctions={},delete b.dropDownDisplay,delete b.modelNameDisplay;var e=d("titleCase")(a.routing.modelName,!0);h(e,0),a.routing.formName&&h(e+d("titleCase")(a.routing.formName,!0),1),a.contextMenu=b.dropDownDisplay||b.modelNameDisplay||d("titleCase")(a.routing.modelName,!1)}}),a.doClick=function(b,c){var d=angular.element(c.target);if(d.parent().hasClass("disabled"))c.preventDefault();else if(a.items[b].broadcast)a.$broadcast(a.items[b].broadcast);else{var e=a.items[b].args||[],f=a.items[b].fn;switch(e.length){case 0:f();break;case 1:f(e[0]);break;case 2:f(e[0],e[1]);break;case 3:f(e[0],e[1],e[2]);break;case 4:f(e[0],e[1],e[2],e[3])}}},a.isHidden=function(b){return a.items[b].isHidden?a.items[b].isHidden():!1},a.isDisabled=function(b){return a.items[b].isDisabled?a.items[b].isDisabled():!1},a.buildUrl=function(a){return f.buildUrl(a)}}]),formsAngular.directive("formButtons",["cssFrameworkService",function(a){return{restrict:"A",templateUrl:"template/form-button-"+a.framework()+".html"}}]),formsAngular.directive("formInput",["$compile","$rootScope","$filter","$data","routingService","cssFrameworkService","formGenerator","formMarkupHelper",function(a,b,c,d,e,f,g,h){return{restrict:"EA",link:function(i,j,k){var l=[],m=!1,n=function(a,b,c,d,g){var j;if(!b){var k=(g.model||"record")+".";if(b=k,g.subschema&&-1!==a.name.indexOf(".")){var l=a.name,m=g.subschemaroot,n=l.slice(m.length+1);g.index?(b+=m+"["+g.index+"]."+n,d="f_"+b.slice(k.length).replace(/(\.|\[|\]\.)/g,"-")):(b+=m,g.subkey?(d=b.slice(k.length).replace(/\./g,"-")+"-subkey"+g.subkeyno+"-"+n,b+="[$_arrayOffset_"+m.replace(/\./g,"_")+"_"+g.subkeyno+"]."+n):(b+="[$index]."+n,d=null,j=l.replace(/\./g,"-")))}else b+=a.name}var o,p=h.allInputsVars(i,a,g,b,d,j),q=p.common,r=c||a.required?" required":"";switch(a.type){case"select":a.select2?(q+='class="fng-select2'+p.formControl+p.compactClass+p.sizeClassBS2+'"',q+=a.readonly?" readonly":"",q+=a.required?' ng-required="true"':"",a.select2.fngAjax?"bs2"===f.framework()?(o='<div class="input-append">',o+='<input ui-select2="'+a.select2.fngAjax+'" '+q+">",o+='<button class="btn" type="button" data-select2-open="'+d+'" ng-click="openSelect2($event)"><i class="icon-search"></i></button>',o+="</div>"):(o='<div class="input-group">',o+='<input ui-select2="'+a.select2.fngAjax+'" '+q+">",o+='<span class="input-group-addon'+p.compactClass+'" data-select2-open="'+d+'" ',o+='    ng-click="openSelect2($event)"><i class="glyphicon glyphicon-search"></i></span>',o+="</div>"):a.select2&&(o='<input ui-select2="'+a.select2.s2query+'" '+q+">")):(q+=a.readonly?"disabled ":"",o="<select "+q+'class="'+p.formControl.trim()+p.compactClass+p.sizeClassBS2+'" '+r+">",c||(o+="<option></option>"),angular.isArray(a.options)?angular.forEach(a.options,function(a){o+=_.isObject(a)?'<option value="'+(a.val||a.id)+'">'+(a.label||a.text)+"</option>":"<option>"+a+"</option>"}):o+='<option ng-repeat="option in '+a.options+'">{{option}}</option>',o+="</select>");break;case"link":o='<a ng-href="/'+e.buildUrl("")+a.ref+(a.form?"/"+a.form:"")+"/{{ "+b+'}}/edit">'+a.linkText+"</a>";break;case"radio":o="",q+=r+(a.readonly?" disabled ":" ");var s="inline"!==g.formstyle&&!a.inlineRadio;if(angular.isArray(a.options))g.subschema&&(q=q.replace('name="','name="{{$index}}-')),angular.forEach(a.options,function(a){o+="<input "+q+'type="radio"',o+=' value="'+a+'">'+a,s&&(o+="<br />")});else{var t=s?"div":"span";g.subschema&&(q=q.replace("$index","$parent.$index").replace('name="','name="{{$parent.$index}}-')),o+="<"+t+' ng-repeat="option in '+a.options+'"><input '+q+' type="radio" value="{{option}}"> {{option}} </'+t+"> "}break;case"checkbox":q+=r+(a.readonly?" disabled ":" "),o="bs3"===f.framework()?'<div class="checkbox"><input '+q+'type="checkbox"></div>':h.generateSimpleInput(q,a,g);break;default:q+=h.addTextInputMarkup(p,a,r),"textarea"===a.type?(a.rows&&(q+="auto"===a.rows?'msd-elastic="\n" class="ng-animate" ':'rows = "'+a.rows+'" '),"ckEditor"===a.editor&&(q+='ckeditor = "" ',"bs3"===f.framework()&&(p.sizeClassBS3="col-xs-12")),o="<textarea "+q+" />"):o=h.generateSimpleInput(q,a,g)}return h.inputChrome(o,a,g,p)},o=function(a){var b;switch(a){case"horizontal":b="form-horizontal";break;case"vertical":b="";break;case"inline":b="form-inline";break;case"horizontalCompact":b="form-horizontal compact";break;default:b="form-horizontal compact"}return b},p=function(a){var b={before:"",after:""};if("function"==typeof a.containerType)b=a.containerType(a);else switch(a.containerType){case"tab":for(var c=-1,d=0;d<i.tabs.length;d++)if(i.tabs[d].title===a.title){c=d;break}c>=0?(b.before="<tab select=\"updateQueryForTab('"+a.title+'\')" heading="'+a.title+'" active="tabs['+c+'].active">',b.after="</tab>"):(b.before="<p>Error!  Tab "+a.title+" not found in tab list</p>",b.after="");break;case"tabset":b.before="<tabset>",b.after="</tabset>";break;case"well":b.before='<div class="well">',a.title&&(b.before+="<h4>"+a.title+"</h4>"),b.after="</div>";break;case"well-large":b.before='<div class="well well-lg well-large">',b.after="</div>";break;case"well-small":b.before='<div class="well well-sm well-small">',b.after="</div>";break;case"fieldset":b.before="<fieldset>",a.title&&(b.before+="<legend>"+a.title+"</legend>"),b.after="</fieldset>";break;case void 0:break;case null:break;case"":break;default:if(b.before='<div class="'+a.containerType+'">',a.title){var e=a.titleTagOrClass||"h4";b.before+=e.match(/h[1-6]/)?"<"+e+">"+a.title+"</"+e+">":'<p class="'+e+'">'+a.title+"</p>"}b.after="</div>"}return b},q=function(a,b){var c=h.fieldChrome(i,a,b),d=c.template;if(a.schema){var e=a.name.replace(/\./g,"_"),g="$_schema_"+e;if(i[g]=a.schema,a.schema)if(a.subkey){a.subkey.path=a.name,i[g+"_subkey"]=a.subkey;for(var j=angular.isArray(a.subkey)?a.subkey:[a.subkey],k=0;k<j.length;k++){var m=p(j[k]);d+=m.before,d+=s(a.schema,null,{subschema:!0,formStyle:b.formstyle,subkey:g+"_subkey",subkeyno:k,subschemaroot:a.name}),d+=m.after}l.push(a)}else d+='<div class="schema-head">'+a.label,a.unshift&&(d+='<button id="unshift_'+a.id+'_btn" class="add-btn btn btn-default btn-xs btn-mini form-btn" ng-click="unshift(\''+a.name+'\',$event)"><i class="'+h.glyphClass()+'-plus"></i> Add</button>'),d+='</div><div ng-form class="'+("bs2"===f.framework()?"row-fluid ":"")+o(a.formStyle)+'" name="form_'+e+'{{$index}}" class="sub-doc well" id="'+a.id+'List_{{$index}}"  ng-repeat="subDoc in '+(b.model||"record")+"."+a.name+' track by $index">   <div class="'+("bs2"===f.framework()?"row-fluid":"row")+' sub-doc">',(!a.noRemove||a.customSubDoc)&&(d+='   <div class="sub-doc-btns">',a.customSubDoc&&(d+=a.customSubDoc),a.noRemove||(d+='<button name="remove_'+a.id+'_btn" class="remove-btn btn btn-mini btn-default btn-xs form-btn" ng-click="remove(\''+a.name+'\',$index,$event)"><i class="'+h.glyphClass()+'-minus"></i> Remove</button>'),d+="  </div> "),d+=s(a.schema,!1,{subschema:!0,formstyle:a.formStyle,model:b.model,subschemaroot:a.name}),d+="   </div></div>",(!a.noAdd||a.customFooter)&&(d+='<div class = "schema-foot">',a.customFooter&&(d+=a.customFooter),a.noAdd||(d+='<button id="add_'+a.id+'_btn" class="add-btn btn btn-default btn-xs btn-mini form-btn" ng-click="add(\''+a.name+'\',$event)"><i class="'+h.glyphClass()+'-plus"></i> Add</button>'),d+="</div>")}else{var q=h.controlDivClasses(b);if(a.array){if(q.push("fng-array"),"inline"===b.formstyle)throw new Error("Cannot use arrays in an inline form");d+=h.label(i,a,!0,b),d+=h.handleArrayInputAndControlDiv(n(a,"arrayItem.x",!0,a.id+"_{{$index}}",b),q,a,b)}else d+=h.label(i,a,null,b),d+=h.handleInputAndControlDiv(n(a,null,b.required,a.id,b),q)}return d+=c.closeTag},r=function(a){a.type=a.type||"text",a.id=a.id||"f_"+a.name.replace(/\./g,"_"),a.label=void 0!==a.label?null===a.label?"":a.label:c("titleCase")(a.name.split(".").slice(-1)[0])},s=function(a,b,c){var d="";if(a)for(var e=0;e<a.length;e++){var f=a[e];0===e&&b&&!c.schema.match(/$_schema_/)&&(f.add=f.add?" "+f.add+" ":"",-1!==f.add.indexOf("ui-date")||c.noautofocus||f.containerType||(f.add=f.add+"autofocus "));var g=!0;if(f.directive){var h=f.directive,l="<"+h+' model="'+(c.model||"record")+'"',n=j[0];r(f);for(var o=0;o<n.attributes.length;o++){var t=n.attributes[o];switch(t.nodeName){case"class":var u=t.value.replace("ng-scope","");u.length>0&&(l+=' class="'+u+'"');break;case"schema":var v=("bespoke_"+f.name).replace(/\./g,"_");i[v]=angular.copy(f),delete i[v].directive,l+=' schema="'+v+'"';break;default:l+=" "+t.nodeName+'="'+t.value+'"'}}var w=k.$normalize(f.directive);for(var x in f)if(f.hasOwnProperty(x))switch(x){case"directive":break;case"schema":break;case"add":switch(typeof f.add){case"string":l+=" "+f.add;break;case"object":for(var y in f.add)l+=" "+y+'="'+f.add[y].toString().replace(/"/g,"&quot;")+'"';break;default:throw new Error("Invalid add property of type "+typeof f.add+" in directive "+f.name)}break;case w:for(var z in f[x])l+=f.directive+"-"+z+'="'+f[x][z]+'"';break;default:l+=" fng-fld-"+x+'="'+f[x].toString().replace(/"/g,"&quot;")+'"'}for(x in c)c.hasOwnProperty(x)&&"$"!==x[0]&&"undefined"!=typeof c[x]&&(l+=" fng-opt-"+x+'="'+c[x].toString().replace(/"/g,"&quot;")+'"');l+="></"+h+">",d+=l,g=!1}else if(f.containerType){var A=p(f);switch(f.containerType){case"tab":m||(m="forced",d+="<tabset>"),d+=A.before,d+=s(f.content,null,c),d+=A.after;break;case"tabset":m=!0,d+=A.before,d+=s(f.content,null,c),d+=A.after;break;default:d+=A.before,d+=s(f.content,null,c),d+=A.after}g=!1}else if(c.subkey){var B=angular.isArray(i[c.subkey])?i[c.subkey][0].keyList:i[c.subkey].keyList;_.find(B,function(a,b){return i[c.subkey].path+"."+b===f.name})&&(g=!1)}g&&(r(f),d+=q(f,c))}else console.log("Empty array passed to processInstructions"),d="";return d},t=i.$watch(k.schema,function(c){if(c&&(c=angular.isArray(c)?c:[c],c.length>0)){t();var e="",f=k.model||"record",h=i[f];if(h=h||{},!k.subschema&&!k.model||k.forceform){i.topLevelFormName=k.name||"myForm";var n="";for(var p in k)k.hasOwnProperty(p)&&"$"!==p[0]&&-1===["name","formstyle","schema","subschema","model"].indexOf(p)&&(n+=" "+k.$attr[p]+'="'+k[p]+'"');e='<form name="'+i.topLevelFormName+'" class="'+o(k.formstyle)+' novalidate"'+n+">"}else e="";if(h===i.topLevelFormName)throw new Error("Model and Name must be distinct - they are both "+h);if(e+=s(c,!0,k),"forced"===m&&(e+="</tabset>"),e+=k.subschema?"":"</form>",j.replaceWith(a(e)(i)),l.length>0||d.modelControllers.length>0)var q=i.$watch("phase",function(a){if("ready"===a){q();for(var b=0;b<d.modelControllers.length;b++)d.modelControllers[b].onAllReady&&d.modelControllers[b].onAllReady(i);for(var c=0;c<l.length;c++){for(var e,f,g=l[c],j=angular.isArray(g.subkey)?g.subkey:[g.subkey],k=g.name.split("."),m=h;k.length>1;)m=m[k.shift()]||{};m=m[k[0]]=m[k[0]]||[];for(var n=0;n<j.length;n++){if(j[n].selectFunc){if(!i[j[n].selectFunc]||"function"!=typeof i[j[n].selectFunc])throw new Error("Subkey function "+j[n].selectFunc+" is not properly set up");e=i[j[n].selectFunc](h,g)}else{if(!j[n].keyList)throw new Error("Invalid subkey setup for "+g.name);var o=j[n].keyList;for(e=0;e<m.length;e++){f=!0;for(var p in o)if(o.hasOwnProperty(p)&&m[e][p]!==o[p]&&("undefined"==typeof m[e][p]||!m[e][p].text||m[e][p].text!==o[p])){f=!1;break}if(f)break}f||(e=h[g.name].push(o)-1)}i["$_arrayOffset_"+g.name.replace(/\./g,"_")+"_"+n]=e}}}});b.$broadcast("formInputDone"),g.updateDataDependentDisplay&&h&&Object.keys(h).length>0&&g.updateDataDependentDisplay(h,null,!0,i)}},!0)}}}]),formsAngular.controller("SearchCtrl",["$scope","$http","$location","routingService",function(a,b,c,d){var e="";a.handleKey=function(b){if(27===b.keyCode&&a.searchTarget.length>0)a.searchTarget="";else if(a.results.length>0)switch(b.keyCode){case 38:a.focus>0&&a.setFocus(a.focus-1),"function"==typeof b.preventDefault&&b.preventDefault();break;case 40:a.results.length>a.focus+1&&a.setFocus(a.focus+1),"function"==typeof b.preventDefault&&b.preventDefault();break;case 13:null!=a.focus&&a.selectResult(a.focus)}},a.setFocus=function(b){null!==a.focus&&delete a.results[a.focus].focussed,a.results[b].focussed=!0,a.focus=b},a.selectResult=function(b){var e=a.results[b],f=d.prefix()+"/"+e.resource+"/"+e.id+"/edit";e.resourceTab&&(f+="/"+e.resourceTab),c.url(f)},a.resultClass=function(b){var c="search-result";return a.results&&a.results[b].focussed&&(c+=" focus"),c};var f=function(){a.moreCount=0,a.errorClass="",a.results=[],a.focus=null};a.$watch("searchTarget",function(c){c&&c.length>0?(e=c,b.get("/api/search?q="+c).success(function(b){e===c&&(a.searchTarget.length>0?(a.results=b.results,a.moreCount=b.moreCount,b.results.length>0&&(a.errorClass="",a.setFocus(0)),a.errorClass=0===a.results.length?"error has-error":""):f())}).error(function(a,b){console.log("Error in searchbox.js : "+a+" (status="+b+")")})):f()},!0),a.$on("$routeChangeStart",function(){a.searchTarget=""})}]).directive("globalSearch",["cssFrameworkService",function(a){return{restrict:"AE",templateUrl:"template/search-"+a.framework()+".html",controller:"SearchCtrl"}}]),formsAngular.filter("titleCase",[function(){return function(a,b){var c=a.replace(/(_|\.)/g," ").replace(/[A-Z]/g," $&").trim().replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()});return c=b?c.replace(/\s/g,""):c.replace(/\s{2,}/g," ")}}]),formsAngular.service("addAllService",function(){function a(a,b,c,d){function e(a){for(var b in a)b===c&&i.push(a[b]),"$parent"===b&&e(a[b])}var f,g,h,i=[],j=[];if(c="addAll"+c,"string"==typeof d)for(f=d.split(" "),g=0;g<f.length;g++)j.push(f[g]);if(e(a),void 0!==b[c]&&"string"==typeof b[c])for(f=b[c].split(" "),g=0;g<f.length;g++)0===f[g].indexOf("class=")?j.push(f[g].substring(6,f[g].length)):i.push(f[g]);return d=j.length>0?' class="'+j.join(" ")+'" ':" ",h=i.length>0?i.join(" ")+" ":"",d+h}this.getAddAllGroupOptions=function(b,c,d){return a(b,c,"Group",d)},this.getAddAllFieldOptions=function(b,c,d){return a(b,c,"Field",d)},this.getAddAllLabelOptions=function(b,c,d){return a(b,c,"Label",d)},this.addAll=function(a,b,c,d){var e="getAddAll"+b+"Options";return this[e](a,d,c)||[]}}),formsAngular.provider("cssFrameworkService",[function(){var a={framework:"bs2"};return{setOptions:function(b){angular.extend(a,b)},$get:function(){return{framework:function(){return a.framework},setFrameworkForDemoWebsite:function(b){a.framework=b},span:function(b){var c;switch(a.framework){case"bs2":c="span"+b;break;case"bs3":c="col-xs-"+b}return c},offset:function(b){var c;switch(a.framework){case"bs2":c="offset"+b;break;case"bs3":c="col-lg-offset-"+b}return c},rowFluid:function(){var b;switch(a.framework){case"bs2":b="row-fluid";break;case"bs3":b="row"}return b}}}}}]),formsAngular.factory("$data",[function(){var a={record:{},disableFunctions:{},dataEventFunctions:{},modelControllers:[]};return a}]),formsAngular.provider("routingService",["$injector","$locationProvider",function(a,b){function c(a,b,c){b=b||"",angular.forEach(a,function(a){f.when(b+a.route,angular.extend(a.options||{templateUrl:a.templateUrl},c))}),h.variantsForDemoWebsite&&angular.forEach(h.variantsForDemoWebsite,function(d){angular.forEach(a,function(a){f.when(b+d+a.route,angular.extend(a.options||{templateUrl:a.templateUrl},c))})})}function d(a,b,c){b=b||"",angular.forEach(a,function(a){g.state(a.state,angular.extend(a.options||{url:b+a.route,templateUrl:a.templateUrl},c))})}function e(a,b,c,d,e,f){var g,h=d?"/"+d:"",i=a+"/"+c,j=f?"/"+f:"";switch(b){case"list":g=i+h;break;case"edit":g=i+h+"/"+e+"/edit"+j;break;case"new":g=i+h+"/new"+j}return g}var f,g,h={hashPrefix:"",html5Mode:!1,routing:"ngroute",prefix:""},i=[{route:"/analyse/:model/:reportSchemaName",state:"analyse::model::report",templateUrl:"partials/base-analysis.html"},{route:"/analyse/:model",state:"analyse::model",templateUrl:"partials/base-analysis.html"},{route:"/:model/:id/edit",state:"model::edit",templateUrl:"partials/base-edit.html"},{route:"/:model/:id/edit/:tab",state:"model::edit::tab",templateUrl:"partials/base-edit.html"},{route:"/:model/new",state:"model::new",templateUrl:"partials/base-edit.html"},{route:"/:model",state:"model::list",templateUrl:"partials/base-list.html"},{route:"/:model/:form/:id/edit",state:"model::form::edit",templateUrl:"partials/base-edit.html"},{route:"/:model/:form/:id/edit/:tab",state:"model::form::edit::tab",templateUrl:"partials/base-edit.html"},{route:"/:model/:form/new",state:"model::form::new",templateUrl:"partials/base-edit.html"},{route:"/:model/:form",state:"model::form::list",templateUrl:"partials/base-list.html"}],j=null,k={};return{start:function(e){switch(angular.extend(h,e),h.prefix[0]&&"/"!==h.prefix[0]&&(h.prefix="/"+h.prefix),b.html5Mode(h.html5Mode),""!==h.hashPrefix&&b.hashPrefix(h.hashPrefix),h.routing){case"ngroute":f=a.get("$routeProvider"),h.fixedRoutes&&c(h.fixedRoutes),c(i,h.prefix,e.add2fngRoutes);break;case"uirouter":g=a.get("$stateProvider"),h.fixedRoutes&&d(h.fixedRoutes),setTimeout(function(){d(i,h.prefix,e.add2fngRoutes)})}},$get:function(){return{router:function(){return h.routing},prefix:function(){return h.prefix},parsePathFunc:function(){return function(a){if(a!==j){j=a,k={newRecord:!1},h.prefix.length>0&&0===a.indexOf(h.prefix)&&(a=a.slice(h.prefix.length));var b=a.split("/");h.variants&&-1!==h.variants.indexOf(b[1])&&(k.variant=b[1],b.shift());var c=b.length;if("analyse"===b[1])k.analyse=!0,k.modelName=b[2],k.reportSchemaName=c>=4?b[3]:null;else{k.modelName=b[1];var d,e=[b[c-1],b[c-2]],f=e.indexOf("new");-1===f?(d=e.indexOf("edit"),-1!==d&&(c-=2+d,k.id=b[c])):(k.newRecord=!0,c-=1+f),(1===d||1===f)&&(k.tab=e[0]),c>2&&(k.formName=b[2])}}return k}},buildUrl:function(a){var b=h.html5Mode?"":"#";return b+=h.hashPrefix,b+=h.prefix,b[0]&&(b+="/"),b+="/"===a[0]?a.slice(1):a},buildOperationUrl:function(a,b,c,d,f){return e(h.prefix,a,b,c,d,f)},redirectTo:function(){return function(a,b,c,d,f){c.search()&&c.url(c.path());var g=e(h.prefix,a,b.modelName,b.formName,d,f);c.path(g)}}}}}}]),formsAngular.factory("formGenerator",function(a,b,c,d,e){function f(a,b,c,d){var e="#"+(c?"cg_":"")+b,f=angular.element(document.querySelector(e));a?f.removeClass(d.fngInvalidRequired):f.addClass(d.fngInvalidRequired)}function g(a,b){for(var c=a.split("."),d=b.record,e=0,f=c.length;f>e;e++)d[c[e]]||(d[c[e]]=e===f-1?[]:{}),d=d[c[e]];return d}var h={};h.generateEditUrl=function(a,b){return d.buildUrl(b.modelName+"/"+(b.formName?b.formName+"/":"")+a._id+"/edit")},h.generateNewUrl=function(a){return d.buildUrl(a.modelName+"/"+(a.formName?a.formName+"/":"")+"new")},h.handleSchema=function(a,b,c,d,e,f,g,l,n){function o(a,b){var c=angular.copy(a),d=_.find(g.tabs,function(a){return a.title===c});if(!d){if(0===g.tabs.length&&g.formSchema.length>0){g.tabs.push({title:"Main",content:[],active:"Main"===g.tab||!g.tab}),d=g.tabs[0];for(var e=0;e<g.formSchema.length;e++)d.content.push(g.formSchema[e])}d=g.tabs[g.tabs.push({title:c,containerType:"tab",content:[],active:c===g.tab})-1]}d.content.push(b)}for(var p in b)if("_id"!==p&&b.hasOwnProperty(p)){var q=b[p],r=q.options||{},s=r.form||{};if(!s.hidden)if(q.schema){if(f&&c){var t=[];h.handleSchema("Nested "+p,q.schema,t,null,p+".",!0,g,l,n);var u=i(p,s,e);u.schema=t,s.tab&&o(s.tab,u),void 0!==s.order?c.splice(s.order,0,u):c.push(u)}}else{if(c){var v=i(p,s,e);if(m(v.showIf,v.name,g)&&"options"!==p){var w=h.handleFieldType(v,q,r,g,l,n);w.tab&&o(w.tab,w),void 0!==s.order?c.splice(s.order,0,w):c.push(w)}}d&&j(d,r.list,p)}}d&&0===d.length&&k(a,d,c,b)},h.handleFieldType=function(d,g,i,j,k,l){var m;if(g.caster&&(d.array=!0,g=g.caster,angular.extend(i,g.options),g.options&&g.options.form&&angular.extend(d,g.options.form)),"String"===g.instance)i["enum"]?(d.type=d.type||"select",d.select2?(j.conversions[d.name]=d.select2,i.required&&(j.$watch("record."+d.name,function(a){f(a,d.id,d.select2,k)},!0),setTimeout(function(){f(j.record[d.name],d.id,d.select2,k)},0)),d.select2===!0&&(d.select2={}),d.select2.s2query="select2"+d.name.replace(/\./g,"_"),j[d.select2.s2query]={allowClear:!i.required,initSelection:function(a,c){function g(){function h(b,c,d){if(c)if(0===b.length)d(c);else{if(angular.isArray(c)){var e=a.context.getAttribute("ng-model"),f=e.indexOf("."+b[0]);e=e.slice(0,f),f=e.lastIndexOf("."),e=e.slice(f+1),e=/.+\[(.+)\]/.exec(e),c=c[j[e[1]]]}c=c[b.shift()],h(b,c,d)}}var i=j.record;if(i){var l=d.name.split(".");h(l,i,function(b){if(setTimeout(f(b,d.id,d.select2,k)),b)if(d.array){var g=parseInt(a.context.id.match("_[0-9].*$")[0].slice(1));b[g].x&&e.preservePristine(a,function(){c(b[g].x)})}else e.preservePristine(a,function(){c(b)})})}else b(g)}b(g)},query:function(a){for(var b={results:[]},c=a.term.toUpperCase(),d=0;d<i["enum"].length;d++)-1!==i["enum"][d].toUpperCase().indexOf(c)&&b.results.push({id:d,text:i["enum"][d]});a.callback(b)}},_.extend(j[d.select2.s2query],d.select2),d.select2===!0&&(d.select2={}),j.select2List.push(d.name)):(d.options=e.suffixCleanId(d,"Options"),j[d.options]=i["enum"])):(d.type||(d.type=-1!==d.name.toLowerCase().indexOf("password")?"password":"text"),i.match&&(d.add='pattern="'+i.match+'" '+(d.add||"")));else if("ObjectID"===g.instance)d.ref=i.ref,d.link&&d.link.linkOnly?(d.type="link",d.linkText=d.link.text,d.form=d.link.form,delete d.link):(d.type="select",d.select2||i.form&&i.form.select2?(d.select2||(d.select2=i.form.select2),d.select2===!0&&(d.select2={}),j.select2List.push(d.name),j.conversions[d.name]=d.select2,d.select2.fngAjax?(m="ajax"+d.name.replace(/\./g,""),i.required||d.placeHolder||(d.placeHolder="Select..."),j[m]={allowClear:!i.required,minimumInputLength:2,initSelection:function(b,d){var f=b.val();f&&""!==f&&c.getListAttributes(i.ref,f).success(function(c){c.success===!1&&a.path("/404");var g={id:f,text:c.list};e.preservePristine(b,function(){d(g)})}).error(l)},ajax:{url:"/api/search/"+i.ref,data:function(a,b){var c,d={q:a,pageLimit:10,page:b};return"object"==typeof i.form.searchQuery?c=i.form.searchQuery:"function"==typeof i.form.searchQuery&&(c=i.form.searchQuery(j,i)),c&&_.extend(d,c),d},results:function(a){return{results:a.results,more:a.moreCount>0}}}},_.extend(j[m],d.select2),d.select2.fngAjax=m):(d.select2===!0&&(d.select2={}),d.select2.s2query="select2"+d.name.replace(/\./g,"_"),j["select2"+d.select2.s2query]={allowClear:!i.required,initSelection:function(a,b){var c=a.val();if(""!==c&&j[d.ids].length>0){var f=e.convertIdToListValue(c,j[d.ids],j[d.options],d.name),g={id:c,text:f};b(g)}},query:function(a){for(var b={results:[]},c=a.term.toUpperCase(),e=0;e<j[d.options].length;e++)-1!==j[d.options][e].toUpperCase().indexOf(c)&&b.results.push({id:j[d.ids][e],text:j[d.options][e]});a.callback(b)}},_.extend(j[d.select2.s2query],d.select2),d.options=e.suffixCleanId(d,"Options"),d.ids=e.suffixCleanId(d,"_ids"),e.setUpSelectOptions(i.ref,d,j,k,h.handleSchema,l))):d.directive&&d[$.camelCase(d.directive)]&&d[$.camelCase(d.directive)].fngAjax||(d.options=e.suffixCleanId(d,"Options"),d.ids=e.suffixCleanId(d,"_ids"),e.setUpSelectOptions(i.ref,d,j,k,h.handleSchema,l)));else if("Date"===g.instance)d.type||(d.readonly?d.type="text":(d.type="text",d.add="ui-date ui-date-format datepicker-popup-fix "));else if("boolean"===g.instance)d.type="checkbox";else{if("Number"!==g.instance)throw new Error("Field "+d.name+" is of unsupported type "+g.instance,d,g);d.type="number",i.min&&(d.add='min="'+i.min+'" '+(d.add||"")),i.max&&(d.add='max="'+i.max+'" '+(d.add||"")),d.step&&(d.add='step="'+d.step+'" '+(d.add||""))}return i.required&&(d.required=!0),i.readonly&&(d.readonly=!0),d};var i=function(a,b,c){return b.name=c+a,b},j=function(a,b,c){var d=b||{hidden:!0};d.hidden||("object"==typeof d?(d.name=c,a.push(d)):a.push({name:c}))},k=function(a,b,c,d){if(c){for(var e=0,f=c.length;f>e;e++)if("text"===c[e].type){b.push({name:c[e].name});break}0===b.length&&0!==c.length&&b.push({name:c[0].name})}if(0===b.length){for(var g in d)if("_id"!==g&&d.hasOwnProperty(g)){b.push({name:g});break}if(0===b.length)throw new Error("Unable to generate a title for "+a)}},l=function(a,b,c){function d(a){var d=a;if("string"==typeof a&&"$"===a.slice(0,1)){var f=a.split(".");switch(f.length){case 1:d=e.getListData(b,a.slice(1),c);break;case 2:d=e.getListData(b,f[1],c);break;default:throw new Error("Unsupported showIf format")}}return d}var f,g=d(a.lhs),h=d(a.rhs);switch(a.comp){case"eq":f=g===h;break;case"ne":f=g!==h;break;default:throw new Error("Unsupported comparator "+a.comp)}return f},m=function(a,b,c){function d(a){if("string"==typeof a&&"$"===a.slice(0,1)){var d=a.slice(1),f=c.dataDependencies[d]||[];f.push(b),c.dataDependencies[d]=f,e+=1}}var e=0,f=!0;return a&&(d(a.lhs),d(a.rhs),0!==e||l(a,void 0,c.select2List)||(f=!1)),f};return h.updateDataDependentDisplay=function(a,b,c,d){var e,f,g,h,i,j;for(var k in d.dataDependencies)if(d.dataDependencies.hasOwnProperty(k)){var m=k.split(".");if(1===m.length){if(c||!b||a[k]!==b[k])for(e=d.dataDependencies[k],f=0;f<e.length;f+=1){var n=e[f];for(g=0;g<d.formSchema.length;g+=1)d.formSchema[g].name===n&&(i=angular.element(document.querySelector("#cg_"+d.formSchema[g].id)),l(d.formSchema[g].showIf,a,d.select2List)?i.removeClass("ng-hide"):i.addClass("ng-hide"))}}else{if(2!==m.length)throw new Error("You can only go down one level of subdocument with showIf");if(void 0===j&&(j=!0),a[m[0]])for(h=0;h<a[m[0]].length;h++)if(c||!b||!b[m[0]]||!b[m[0]][h]||a[m[0]][h][m[1]]!==b[m[0]][h][m[1]])for(e=d.dataDependencies[k],f=0;f<e.length;f+=1){var o=e[f].split(".");if(2!==o.length)throw new Error("Conditional display must control dependent fields at same level ");for(g=0;g<d.formSchema.length;g+=1)if(d.formSchema[g].name===o[0])for(var p=d.formSchema[g].schema,q=0;q<p.length;q++)p[q].name===e[f]&&(i=angular.element(document.querySelector("#f_"+o[0]+"List_"+h+" #cg_f_"+e[f].replace(".","_"))),0===i.length?i=angular.element(document.querySelector("#f_elements-"+h+"-"+o[1])):j=!1,i.length>0&&(l(d.formSchema[g].schema[q].showIf,a[m[0]][h],d.select2List)?i.show():i.hide()))}}}return j},h.add=function(a,b,c){var d=g(a,c);d.push({}),c.setFormDirty(b)},h.unshift=function(a,b,c){var d=g(a,c);d.unshift({}),c.setFormDirty(b)},h.remove=function(a,b,c,d){for(var e=a.split("."),f=d.record,g=0,h=e.length;h>g;g++)f=f[e[g]];f.splice(b,1),d.setFormDirty(c)},h.hasError=function(a,b,c,d){var e=d[d.topLevelFormName];if("null"!==a&&(e=e[a.replace("$index",c)]),e){var f=e[b];if(f&&f.$invalid)return!0}},h.decorateScope=function(a,b,c,d){a.record=d.record,a.phase="init",a.disableFunctions=d.disableFunctions,a.dataEventFunctions=d.dataEventFunctions,a.topLevelFormName=void 0,a.formSchema=[],a.tabs=[],a.listSchema=[],a.recordList=[],a.dataDependencies={},a.select2List=[],a.conversions={},a.pageSize=60,a.pagesLoaded=0,d.baseScope=a,a.generateEditUrl=function(c){return b.generateEditUrl(c,a)},a.generateNewUrl=function(){return b.generateNewUrl(a)},a.scrollTheList=function(){return c.scrollTheList(a,c.handleError(a))},a.getListData=function(b,d){return c.getListData(b,d,a.select2List)},a.setPristine=function(){a.dismissError(),a[a.topLevelFormName]&&a[a.topLevelFormName].$setPristine()},a.skipCols=function(a){return a>0?"col-md-offset-3":""},a.setFormDirty=function(a){if(a){var b=angular.element(a.target).inheritedData("$formController");b.$setDirty()}else console.log("setFormDirty called without an event (fine in a unit test)")},a.add=function(c,d){return b.add(c,d,a)},a.hasError=function(c,d,e){return b.hasError(c,d,e,a)},a.unshift=function(c,d){return b.unshift(c,d,a)},a.remove=function(c,d,e){return b.remove(c,d,e,a)},a.openSelect2=function(a){$("#"+$(a.currentTarget).data("select2-open")).select2("open")},a.toJSON=function(a){return"The toJSON function is deprecated - use the json filter instead\n\n"+JSON.stringify(a,null,2)},a.baseSchema=function(){return a.tabs.length?a.tabs:a.formSchema}},h}),formsAngular.factory("formMarkupHelper",["cssFrameworkService","inputSizeHelper","addAllService",function(a,b,c){function d(a,b){function c(a){var c=a;if("string"==typeof a)if("$"===a.slice(0,1)){c=(b||"record")+".";var d=a.slice(1).split(".");if(d.length>1){var e=d.pop();c+=d.join(".")+"[$index]."+e}else c+=a.slice(1)}else c="'"+a+"'";return c}var d=["eq","ne","gt","gte","lt","lte"],e=["===","!==",">",">=","<","<="],f=d.indexOf(a.comp);if(-1===f)throw new Error("Invalid comparison in showWhen");return c(a.lhs)+e[f]+c(a.rhs)}var e={};return e.isHorizontalStyle=function(a){return!a||"undefined"===a||-1===["vertical","inline"].indexOf(a)},e.fieldChrome=function(f,g,h){var i="",j="",k="",l="";if(g.showWhen=g.showWhen||g.showwhen,g.showWhen&&(l+="string"==typeof g.showWhen?'ng-show="'+g.showWhen+'"':'ng-show="'+d(g.showWhen,h.model)+'"'),l+=' id="cg_'+g.id.replace(/\./g,"-")+'"',"bs3"===a.framework()){i="form-group","vertical"===h.formstyle&&"block-level"!==g.size&&(j+='<div class="row">',i+=" col-sm-"+b.sizeAsNumber(g.size),k+="</div>");var m,n=null,o=g.name.split(".");h&&"undefined"!=typeof h.subkeyno?m=h.subschemaroot.replace(/\./g,"-")+"-subkey"+h.subkeyno+"-"+o[o.length-1]:h.subschema?(n="form_"+o[0]+"$index",m=g.name.replace(/\./g,"-")):m="f_"+g.name.replace(/\./g,"_"),j+="<div"+c.addAll(f,"Group",i,h)+" ng-class=\"{'has-error': hasError('"+n+"','"+m+"', $index)}\"",k+="</div>"}else e.isHorizontalStyle(h.formstyle)?(j+="<div"+c.addAll(f,"Group","control-group",h),k="</div>"):(j+="<span ",k="</span>");return j+=(l||"")+">",{template:j,closeTag:k}},e.label=function(b,d,f,g){var h="";if("bs3"===a.framework()||"inline"!==g.formstyle&&""!==d.label||f){h="<label";var i="control-label";e.isHorizontalStyle(g.formstyle)?(h+=' for="'+d.id+'"',"undefined"!=typeof d.labelDefaultClass?i+=" "+d.labelDefaultClass:"bs3"===a.framework()&&(i+=" col-sm-3")):"inline"===g.formstyle&&(h+=' for="'+d.id+'"',i+=" sr-only"),h+=c.addAll(b,"Label",null,g)+' class="'+i+'">'+d.label,f&&(h+=' <i id="add_'+d.id+'" ng-click="add(\''+d.name+'\',$event)" class="'+e.glyphClass()+'-plus-sign"></i>'),h+="</label>"
}return h},e.glyphClass=function(){return"bs2"===a.framework()?"icon":"glyphicon glyphicon"},e.allInputsVars=function(d,e,f,g,h,i){var j,k=e.placeHolder,l="",m="",n="",o="";return"bs3"===a.framework()?(l=-1===["horizontal","vertical","inline"].indexOf(f.formstyle)?" input-sm":"",m="col-sm-"+b.sizeAsNumber(e.size),o=" form-control"):n=e.size?" input-"+e.size:"","inline"===f.formstyle&&(k=k||e.label),j='ng-model="'+g+'"'+(h?' id="'+h+'" name="'+h+'" ':' name="'+i+'" '),j+=k?'placeholder="'+k+'" ':"",e.popup&&(j+='title="'+e.popup+'" '),j+=c.addAll(d,"Field",null,f),{common:j,sizeClassBS3:m,sizeClassBS2:n,compactClass:l,formControl:o}},e.inputChrome=function(b,c,d,f){return"bs3"===a.framework()&&e.isHorizontalStyle(d.formstyle)&&"checkbox"!==c.type&&(b='<div class="bs3-input '+f.sizeClassBS3+'">'+b+"</div>"),c.helpInline&&(b+='<span class="'+("bs2"===a.framework()?"help-inline":"help-block")+'">'+c.helpInline+"</span>"),c.help&&(b+='<span class="help-block">'+c.help+"</span>"),b},e.generateSimpleInput=function(b,c,d){var e="<input "+b+'type="'+c.type+'"';return"inline"!==d.formstyle||"bs2"!==a.framework()||c.size||(e+='class="input-small"'),e+=" />"},e.controlDivClasses=function(b){var c=[];return e.isHorizontalStyle(b.formstyle)&&c.push("bs2"===a.framework()?"controls":"col-sm-9"),c},e.handleInputAndControlDiv=function(a,b){return b.length>0&&(a='<div class="'+b.join(" ")+'">'+a+"</div>"),a},e.handleArrayInputAndControlDiv=function(b,c,d,f){var g="<div ";return"bs3"===a.framework()&&(g+='ng-class="skipCols($index)" '),g+='class="'+c.join(" ")+'" id="'+d.id+'List" ',g+='ng-repeat="arrayItem in '+(f.model||"record")+"."+d.name+' track by $index">',g+=b,g+="<i ng-click=\"remove('"+d.name+'\',$index,$event)" id="remove_'+d.id+'_{{$index}}" class="'+e.glyphClass()+'-minus-sign"></i>',g+="</div>"},e.addTextInputMarkup=function(a,b,c){var d="",e=a.formControl.trim()+a.compactClass+a.sizeClassBS2+(b["class"]?" "+b["class"]:"");return 0!==e.length&&(d+='class="'+e+'"'),b.add&&(d+=" "+b.add+" "),d+=c+(b.readonly?" readonly":"")+" "},e}]),formsAngular.factory("inputSizeHelper",[function(){var a=[1,2,4,6,8,10,12],b=["mini","small","medium","large","xlarge","xxlarge","block-level"],c=2,d={sizeMapping:a,sizeDescriptions:b,defaultSizeOffset:c,sizeAsNumber:function(d){return a[d?b.indexOf(d):c]}};return d}]),formsAngular.factory("pluginHelper",["formMarkupHelper",function(a){var b={};return b.extractFromAttr=function(a,b){var c={},d={formStyle:a.formstyle},e={},f=b.length;for(var g in a)a.hasOwnProperty(g)&&("fngFld"===g.slice(0,6)?c[g.slice(6).toLowerCase()]=a[g].replace(/&quot;/g,'"'):"fngOpt"===g.slice(0,6)?d[g.slice(6).toLowerCase()]=a[g].replace(/&quot;/g,'"'):g.slice(0,f)===b&&(e[g.slice(f).toLowerCase()]=a[g].replace(/&quot;/g,'"')));return{info:c,options:d,directiveOptions:e}},b.buildInputMarkup=function(b,c,d,e,f,g,h){var i,j,k,l=a.fieldChrome(b,d,e,' id="cg_'+d.id+'"'),m=a.controlDivClasses(e),n=l.template+a.label(b,d,f,e);if(f?(i="arrayItem"+(g?".x":""),j=d.id+"_{{$index}}",k=d.name+"_{{$index}}"):(i=c+"."+d.name,j=d.id,k=d.name),e.subschema&&-1!==d.name.indexOf(".")){var o=c+".",p=d.name,q=e.subschemaroot,r=p.slice(q.length+1);i=o,e.index?(i+=q+"["+e.index+"]."+r,j="f_"+i.slice(o.length).replace(/(\.|\[|\]\.)/g,"-")):(i+=q,e.subkey?(j=i.slice(o.length).replace(/\./g,"-")+"-subkey"+e.subkeyno+"-"+r,i+="[$_arrayOffset_"+q.replace(/\./g,"_")+"_"+e.subkeyno+"]."+r):(i+="[$index]."+r,j=null,k=p.replace(/\./g,"-")))}var s=a.allInputsVars(b,d,e,i,j,k);return n+=a["handle"+(f?"Array":"")+"InputAndControlDiv"](a.inputChrome(h(s),d,e,s),m,d,e),n+=l.closeTag},b.findIdInSchemaAndFlagNeedX=function(a,c){for(var d=!1,e=0;e<a.length;e++){var f=a[e];if(f.id===c){f.needsX=!0,d=!0;break}if(f.schema&&b.findIdInSchemaAndFlagNeedX(f.schema,c)){d=!0;break}}return d},b}]),formsAngular.factory("recordHandler",function(a,b,c,d,e,f,g){function h(a){var b=a.split("."),c=[b[0]];return b.length>1&&c.push(b.slice(1).join(".")),c}function i(a,b,c){var d=h(a);if(d.length>1)j(d[1],b[d[0]],c);else if(b[d[0]]){var e=b[d[0]];if(angular.isArray(e))for(var f=e.length-1;f>=0;f--){var g=typeof e[f];("undefined"===g||"object"===g&&0===Object.keys(e[f]).length)&&e.splice(f,1)}b[d[0]]=c(e)}}function j(a,b,c){if(void 0!==b)if(angular.isArray(b))for(var d=0;d<b.length;d++)i(a,b[d],c);else i(a,b,c)}function k(a,b,c,d){if(a.array){for(var e=[],f=!a.directive||q(a),g=0;g<b.length;g++){var h=b[g];h&&h.x&&(h=h.x);var i=m.convertIdToListValue(h,d,c,a.name);f&&(i={x:i}),e.push(i)}return e}return a.select2?{id:b,text:m.convertIdToListValue(b,d,c,a.name)}:m.convertIdToListValue(b,d,c,a.name)}function l(a,b,c,d){if(a.array){for(var e=[],f=0;f<b.length;f++)e.push(s(b[f],c,d,a.name));return e}return s(b,c,d,a.name)}var m={};m.processServerData=function(a,b,c){c.master=r(b.formSchema,a,0,b),b.phase="ready",b.cancel()},m.readRecord=function(b,c,d){f.readRecord(b.modelName,b.id).success(function(d){d.success===!1&&a.path("/404"),c.allowLocationChange=!1,b.phase="reading","function"==typeof b.dataEventFunctions.onAfterRead&&b.dataEventFunctions.onAfterRead(d),m.processServerData(d,b,c)}).error(d)},m.scrollTheList=function(b,c){var d=b.pagesLoaded;f.getPagedAndFilteredList(b.modelName,{aggregate:a.$$search.a,find:a.$$search.f,limit:b.pageSize,skip:d*b.pageSize,order:a.$$search.o}).success(function(a){angular.isArray(a)?d===b.pagesLoaded?(b.pagesLoaded++,b.recordList=b.recordList.concat(a)):console.log("DEBUG: infinite scroll component asked for a page twice"):b.showError(a,"Invalid query")}).error(c)},m.deleteRecord=function(b,c,d,g){f.deleteRecord(b,c).success(function(){"function"==typeof d.dataEventFunctions.onAfterDelete&&d.dataEventFunctions.onAfterDelete(g.master),e.redirectTo()("list",d,a)})},m.updateDocument=function(a,c,d,e,g){d.phase="updating",f.updateRecord(d.modelName,d.id,a).success(function(a){a.success!==!1?("function"==typeof d.dataEventFunctions.onAfterUpdate&&d.dataEventFunctions.onAfterUpdate(a,g.master),c.redirect?(c.allowChange&&(g.allowLocationChange=!0),b.location=c.redirect):(m.processServerData(a,d,g),d.setPristine())):d.showError(a)}).error(e)},m.createNew=function(c,d,g,h){f.createRecord(g.modelName,c).success(function(c){c.success!==!1?("function"==typeof g.dataEventFunctions.onAfterCreate&&g.dataEventFunctions.onAfterCreate(c),d.redirect?b.location=d.redirect:e.redirectTo()("edit",g,a,c._id)):g.showError(c)}).error(h)},m.getListData=function(a,b,c){for(var d=b.split("."),e=0;e<d.length;e++)void 0!==a&&(a=a[d[e]]);return a&&-1!==c.indexOf(d[e-1])&&(a=a.text||a),void 0===a&&(a=""),a};var n=function(a,b,c){for(var d=b.split("."),e=d.length-1,f=a,g=0;e>g&&(f=angular.isArray(f)?_.map(f,function(a){return a[d[g]]}):f[d[g]],angular.isArray(f)&&c&&c.scope&&"function"==typeof c.scope&&(f=f[c.scope().$index]),f);g++);return{lastObject:f,key:f?d[e]:void 0}};m.suffixCleanId=function(a,b){return(a.id||"f_"+a.name).replace(/\./g,"_")+b};var o=function(a,b,c){var d,e=n(a,b,c);return e.lastObject&&e.key&&(d=angular.isArray(e.lastObject)?_.map(e.lastObject,function(a){return a[e.key]}):e.lastObject[e.key]),d};m.setData=function(a,b,c,d){var e=n(a,b,c);if(e.lastObject&&e.key)if(angular.isArray(e.lastObject))for(var f=0;f<e.lastObject.length;f++)e.lastObject[f][e.key]=d[f];else e.lastObject[e.key]=d};var p=function(a,b,c){if(!b.topLevelFormName||b[b.topLevelFormName].$pristine){i(a.name,c.master,function(c){return k(a,c,b[m.suffixCleanId(a,"Options")],b[m.suffixCleanId(a,"_ids")])});var d=o(c.master,a.name);d&&m.setData(b.record,a.name,void 0,d)}};m.setUpSelectOptions=function(a,b,c,d,e,h){var i=c[b.options]=[],j=c[b.ids]=[];g.getSchema(a).success(function(g){var k=[];e("Lookup "+a,g,null,k,"",!1,c,d,h);var l;"undefined"!=typeof b.filter&&b.filter?(console.log("filtering"),l=f.getPagedAndFilteredList(a,b.filter)):l=f.getAll(a),l.success(function(a){if(a){for(var e=0;e<a.length;e++){for(var f="",g=0;g<k.length;g++)f+=a[e][k[g].name]+" ";f=f.trim();var h=_.sortedIndex(i,f);i[h]===f&&(f=f+"    ("+a[e]._id+")",h=_.sortedIndex(i,f)),i.splice(h,0,f),j.splice(h,0,a[e]._id)}p(b,c,d)}})})};var q=function(a){var b=!1;return"text"===a.type?b=!0:(a.needsX||"select"===a.type&&!a.ids&&!a.directive)&&(b=!0),b},r=function(a,b,c,d,e){e=e||b;for(var f=0;f<a.length;f++){var g=a[f],h=g.name.slice(c),i=o(b,h);if(g.schema){if(i)for(var j=0;j<i.length;j++)i[j]=r(g.schema,i[j],c+1+h.length,d,e)}else{var l=m.getListData(b,h,d.select2List);if(g.array&&q(g)&&l)for(var n=0;n<l.length;n++)l[n]={x:l[n]};var p=d[m.suffixCleanId(g,"_ids")];if(i&&p&&p.length>0){if(-1!==h.indexOf("."))throw new Error("Trying to directly assign to a nested field 332");b[h]=k(g,i,d[m.suffixCleanId(g,"Options")],p)}else if(g.select2&&!g.select2.fngAjax){if(i)if(g.array)for(var s=0;s<i.length;s++)d[g.select2.s2query].query({term:i[s].x.text||i[s].text||i[s].x||i[s],callback:function(a){if(a.results.length>0)if(i[s].x){if(-1!==h.indexOf("."))throw new Error("Trying to directly assign to a nested field 342");b[h][s].x=a.results[0]}else{if(-1!==h.indexOf("."))throw new Error("Trying to directly assign to a nested field 345");b[h][s]=a.results[0]}}});else d[g.select2.s2query].query({term:i,callback:function(a){if(a.results.length>0){if(-1!==h.indexOf("."))throw new Error("Trying to directly assign to a nested field 357");b[h]=a.results[0]}}})}else if(g.select2)void g.select2;else if(i&&d.conversions[g.name]&&d.conversions[g.name].fngajax){var t=g;d.conversions[t.name].fngajax(i,t,function(a,b){m.setData(e,a.name,void 0,b),m.preservePristine(angular.element("#"+a.id),function(){m.setData(d.record,a.name,void 0,b)})})}}}return b};m.preservePristine=function(a,b){var c=a.inheritedData("$ngModelController"),d=c&&c.$pristine;d&&(c.$pristine=!1),b(),d&&(c.$pristine=!0)},m.convertToMongoModel=function(a,b,c,d){function e(a,b){var c;return b.select2&&b.select2.fngAjax||d.conversions[b.name]&&d.conversions[b.name].fngajax?a&&a.id&&(c=a.id):a&&(c=a.text||(a.x?a.x.text:a)),c}for(var f=0;f<a.length;f++){var g=a[f].name.slice(c),h=m.getListData(b,g,d.select2List);if(a[f].schema){if(h)for(var j=0;j<h.length;j++)h[j]=m.convertToMongoModel(a[f].schema,h[j],c+1+g.length,d)}else{if(a[f].array&&q(a[f])&&h)for(var k=0;k<h.length;k++)h[k]=h[k].x;var n=d[m.suffixCleanId(a[f],"_ids")];if(n&&n.length>0)i(g,b,function(b){return l(a[f],b,d[m.suffixCleanId(a[f],"Options")],n)});else if(d.conversions[a[f].name]){var p,r=o(b,g,null);if(a[f].array){if(p=[],r)for(var s=0;s<r.length;s++)p[s]=e(r[s],a[f])}else p=e(r,a[f]);m.setData(b,g,null,p)}}}return b},m.convertIdToListValue=function(a,b,c,d){var e=b.indexOf(a);if(-1===e)throw new Error("convertIdToListValue: Invalid data - id "+a+" not found in "+b+" processing "+d);return c[e]};var s=function(a,b,c,d){var e=_.isObject(a)?a.x||a.text:a;if(e&&e.match(/^[0-9a-f]{24}$/))return e;var f=b.indexOf(e);if(-1===f)throw new Error("convertListValueToId: Invalid data - value "+e+" not found in "+b+" processing "+d);return c[f]};return m.handleError=function(a){return function(b,d){if(-1!==[200,400].indexOf(d)){var e="";for(var f in b.errors)if(b.errors.hasOwnProperty(f)){switch(e+="<li><b>"+c("titleCase")(f)+": </b> ",b.errors[f].type){case"enum":e+="You need to select from the list of values";break;default:e+=b.errors[f].message}e+="</li>"}e=e.length>0?b.message+"<br /><ul>"+e+"</ul>":b.message||"Error!  Sorry - No further details available.",a.showError(e)}else a.showError(d+" "+JSON.stringify(b))}},m.decorateScope=function(c,f,g,h){c.cancel=function(){angular.copy(h.master,c.record),d(c.setPristine)};var i=m.handleError(c);c.$on("showErrorMessage",function(a,b){c.showError(b.body,b.title)}),c.showError=function(a,b){c.alertTitle=b?b:"Error!",c.errorMessage=a},c.dismissError=function(){delete c.errorMessage},c.save=function(a){a=a||{};var b=g.convertToMongoModel(c.formSchema,angular.copy(c.record),0,c);c.id?"function"==typeof c.dataEventFunctions.onBeforeUpdate?c.dataEventFunctions.onBeforeUpdate(b,h.master,function(d){d?c.showError(d):g.updateDocument(b,a,c,i,h)}):g.updateDocument(b,a,c,i,h):"function"==typeof c.dataEventFunctions.onBeforeCreate?c.dataEventFunctions.onBeforeCreate(b,function(d){d?c.showError(d):g.createNew(b,a,c,i)}):g.createNew(b,a,c,i)},c.newClick=function(){e.redirectTo()("new",c,a)},c.$on("$locationChangeStart",function(a,d){if(!h.allowLocationChange&&!c.isCancelDisabled()){a.preventDefault();var e=f.open({template:'<div class="modal-header">   <h3>Record modified</h3></div><div class="modal-body">   <p>Would you like to save your changes?</p></div><div class="modal-footer">    <button class="btn btn-primary dlg-yes" ng-click="yes()">Yes</button>    <button class="btn btn-warning dlg-no" ng-click="no()">No</button>    <button class="btn dlg-cancel" ng-click="cancel()">Cancel</button></div>',controller:"SaveChangesModalCtrl",backdrop:"static"});e.result.then(function(a){a?c.save({redirect:d,allowChange:!0}):(h.allowLocationChange=!0,b.location=d)})}}),c.deleteClick=function(){if(c.record._id){var a=f.open({template:'<div class="modal-header">   <h3>Delete Item</h3></div><div class="modal-body">   <p>Are you sure you want to delete this record?</p></div><div class="modal-footer">    <button class="btn btn-primary dlg-no" ng-click="cancel()">No</button>    <button class="btn btn-warning dlg-yes" ng-click="yes()">Yes</button></div>',controller:"SaveChangesModalCtrl",backdrop:"static"});a.result.then(function(a){a&&("function"==typeof c.dataEventFunctions.onBeforeDelete?c.dataEventFunctions.onBeforeDelete(h.master,function(a){a?c.showError(a):g.deleteRecord(c.modelName,c.id,c,h)}):g.deleteRecord(c.modelName,c.id,c,h))})}},c.isCancelDisabled=function(){return"function"==typeof c.disableFunctions.isCancelDisabled?c.disableFunctions.isCancelDisabled(c.record,h.master,c[c.topLevelFormName]):c[c.topLevelFormName]&&c[c.topLevelFormName].$pristine},c.isSaveDisabled=function(){return"function"==typeof c.disableFunctions.isSaveDisabled?c.disableFunctions.isSaveDisabled(c.record,h.master,c[c.topLevelFormName]):c[c.topLevelFormName]&&(c[c.topLevelFormName].$invalid||c[c.topLevelFormName].$pristine)},c.isDeleteDisabled=function(){return"function"==typeof c.disableFunctions.isDeleteDisabled?c.disableFunctions.isDeleteDisabled(c.record,h.master,c[c.topLevelFormName]):!c.id},c.isNewDisabled=function(){return"function"==typeof c.disableFunctions.isNewDisabled?c.disableFunctions.isNewDisabled(c.record,h.master,c[c.topLevelFormName]):!1},c.disabledText=function(a){var b="";return c.isSaveDisabled&&(b="This button is only enabled when the form is complete and valid.  Make sure all required inputs are filled in. "+a),b},c.getVal=function(a,b){if(-1===a.indexOf("$index")||"undefined"!=typeof b)return a=a.replace(/\$index/g,b),c.$eval("record."+a);throw new Error("Invalid expression in getVal(): ",a)}},m.fillFormFromBackendCustomSchema=function(a,b,c,d,e,f){var g=!b.id&&!b.newRecord;if(c.handleSchema("Main "+b.modelName,a,g?null:b.formSchema,b.listSchema,"",!0,b,e,f),g)e.allowLocationChange=!0;else{var h=!0;b.$watch("record",function(a,d){a!==d&&(h=c.updateDataDependentDisplay(a,d,h,b))},!0),b.id?"function"==typeof b.dataEventFunctions.onBeforeRead?b.dataEventFunctions.onBeforeRead(b.id,function(a){a?b.showError(a):d.readRecord(b,e,f)}):d.readRecord(b,e,f):(e.master={},b.phase="ready",b.cancel())}},m.fillFormWithBackendSchema=function(a,b,c,d,e){g.getSchema(a.modelName,a.formName).success(function(f){m.fillFormFromBackendCustomSchema(f,a,b,c,d,e)}).error(e)},m}),formsAngular.factory("SchemasService",["$http",function(a){return{getSchema:function(b,c){return a.get("/api/schema/"+b+(c?"/"+c:""),{cache:!0})}}}]),formsAngular.factory("SubmissionsService",["$http",function(a){var b=function(a){var b="",c=function(a,c){c&&""!==c&&("object"==typeof c&&(c=JSON.stringify(c)),""===b?b="?":b+="&",b+=a+"="+c)};return c("l",a.limit),c("f",a.find),c("a",a.aggregate),c("o",a.order),c("s",a.skip),b};return{getListAttributes:function(b,c){return a.get("/api/"+b+"/"+c+"/list")},readRecord:function(b,c){return a.get("/api/"+b+"/"+c)},getAll:function(b){return a.get("/api/"+b,{cache:!0})},getPagedAndFilteredList:function(c,d){return a.get("/api/"+c+b(d))},deleteRecord:function(b,c){return a["delete"]("/api/"+b+"/"+c)},updateRecord:function(b,c,d){return a.post("/api/"+b+"/"+c,d)},createRecord:function(b,c){return a.post("/api/"+b,c)}}}]),angular.module("formsAngular").run(["$templateCache",function(a){a.put("template/form-button-bs2.html",'<div class=form-btn-grp><div class="btn-group pull-right"><button id=saveButton class="btn btn-mini btn-primary form-btn" ng-click=save() ng-disabled=isSaveDisabled()><i class=icon-ok></i> Save</button> <button id=cancelButton class="btn btn-mini btn-warning form-btn" ng-click=cancel() ng-disabled=isCancelDisabled()><i class=icon-remove></i> Cancel</button></div><div class="btn-group pull-right"><button id=newButton class="btn btn-mini btn-success form-btn" ng-click=newClick() ng-disabled=isNewDisabled()><i class=icon-plus></i> New</button> <button id=deleteButton class="btn btn-mini btn-danger form-btn" ng-click=deleteClick() ng-disabled=isDeleteDisabled()><i class=icon-minus></i> Delete</button></div></div>'),a.put("template/form-button-bs3.html",'<div class=form-btn-grp><div class="btn-group pull-right"><button id=saveButton class="btn btn-primary form-btn btn-xs" ng-click=save() ng-disabled=isSaveDisabled()><i class="glyphicon glyphicon-ok"></i> Save</button> <button id=cancelButton class="btn btn-warning form-btn btn-xs" ng-click=cancel() ng-disabled=isCancelDisabled()><i class="glyphicon glyphicon-remove"></i> Cancel</button></div><div class="btn-group pull-right"><button id=newButton class="btn btn-success form-btn btn-xs" ng-click=newClick() ng-disabled=isNewDisabled()><i class="glyphicon glyphicon-plus"></i> New</button> <button id=deleteButton class="btn btn-danger form-btn btn-xs" ng-click=deleteClick() ng-disabled=isDeleteDisabled()><i class="glyphicon glyphicon-minus"></i> Delete</button></div></div>'),a.put("template/search-bs2.html",'<form class="navbar-search pull-right"><div id=search-cg class=control-group ng-class=errorClass><input id=searchinput ng-model=searchTarget class=search-query placeholder="Ctrl + / to Search" ng-keyup=handleKey($event)></div></form><div class=results-container ng-show="results.length >= 1"><div class=search-results><div ng-repeat="result in results"><span ng-class=resultClass($index) ng-click=selectResult($index)>{{result.resourceText}} {{result.text}}</span></div><div ng-show="moreCount > 0">(plus more - continue typing to narrow down search...)</div></div></div>'),a.put("template/search-bs3.html",'<form class="pull-right navbar-form"><div id=search-cg class=form-group ng-class=errorClass><input id=searchinput ng-model=searchTarget class="search-query form-control" placeholder="Ctrl + / to Search" ng-keyup=handleKey($event)></div></form><div class=results-container ng-show="results.length >= 1"><div class=search-results><div ng-repeat="result in results"><span ng-class=resultClass($index) ng-click=selectResult($index)>{{result.resourceText}} {{result.text}}</span></div><div ng-show="moreCount > 0">(plus more - continue typing to narrow down search...)</div></div></div>')}]);