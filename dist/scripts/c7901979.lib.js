/*! forms-angular 2014-05-15 */
"use strict";function ngGridCsvExportPlugin(a){var b=this;b.grid=null,b.scope=null,b.init=function(c,d){function e(){var a=angular.element("h1").parent(),c=angular.element("#csv-data-link");null!=c&&c.remove();var d='<button id="csv-data-link" class="btn"><a href="data:text/csv;charset=UTF-8,';d+=encodeURIComponent(b.prepareCSV()),d+='" download="Export.csv">CSV Export</button>',a.append(d)}b.grid=d,b.scope=c,a.inhibitButton||(setTimeout(e,0),c.catHashKeys=function(){var a="";for(var b in c.renderedRows)a+=c.renderedRows[b].$$hashKey;return a},c.$watch("catHashKeys()",e))},b.createCSV=function(){window.open("data:text/csv;charset=UTF-8,"+encodeURIComponent(b.prepareCSV()))},b.prepareCSV=function(){function a(a){return null==a?"":"number"==typeof a?""+a:"boolean"==typeof a?a?"TRUE":"FALSE":"string"==typeof a?a.replace(/"/g,'""'):JSON.stringify(a).replace(/"/g,'""')}function c(a){var b=a.substr(0,a.length-1);return b+"\n"}var d="";return angular.forEach(b.scope.columns,function(b){b.visible&&(void 0===b.width||b.width>0)&&(d+='"'+a(b.displayName)+'",')}),d=c(d),angular.forEach(b.grid.filteredRows,function(e){angular.forEach(b.scope.columns,function(b){b.visible&&(d+='"'+a(e.entity[b.field])+'",')}),d=c(d)}),d}}function ngGridPdfExportPlugin(a){var b=this;b.grid=null,b.scope=null,b.services=null,b.options=a,b.init=function(c,d,e){if(b.grid=d,b.scope=c,b.services=e,!a.inhibitButton){var f=d.$root.find(".ngFooterPanel"),g=d.$root.find(".ngFooterPanel .pdf-data-link-span");null!=g&&g.remove();var h='<button class="pdf-data-link-span">PDF Export</button>';f.append(h),f.on("click",function(){b.createPDF()})}},b.createPDF=function(){var a=[],c=[],d={},e=b.scope.totalRowWidth(),f=15;angular.forEach(b.scope.columns,function(c){c.visible&&(void 0===c.width||c.width>0)&&(a.push({name:c.field,prompt:c.displayName,width:c.width*(185/e),align:c.colDef.align||"left"}),c.colDef.totalsRow&&(d[c.field]=b.scope.getTotalVal(c.field,c.filter).toString()))}),angular.forEach(b.grid.filteredRows,function(a){c.push(angular.copy(a.entity))});var g=new jsPDF("landscape","mm","a4");g.setFontStyle("bold"),g.setFontSize(24),g.text(b.scope.reportSchema.title,f,f),g.setFontStyle("normal"),g.setFontSize(12),g.cellInitialize(),g.table(f,24,c,{headers:a,footers:d,printHeaders:!0,autoSize:!1,margins:{left:f,top:f,bottom:f,width:g.internal.pageSize-f}}),g.output("dataurlnewwindow")}}var formsAngular=angular.module("formsAngular",["ngRoute","ngSanitize","ui.select2","ui.date","ui.bootstrap","ngGrid","infinite-scroll","monospaced.elastic","ngCkeditor"]);angular.module("formsAngular").run(["$templateCache",function(a){a.put("template/form-button-bs2.html",'<div class="btn-group pull-right"><button id=saveButton class="btn btn-mini btn-primary form-btn" ng-click=save() ng-disabled=isSaveDisabled()><i class=icon-ok></i> Save</button> <button id=cancelButton class="btn btn-mini btn-warning form-btn" ng-click=cancel() ng-disabled=isCancelDisabled()><i class=icon-remove></i> Cancel</button></div><div class="btn-group pull-right"><button id=newButton class="btn btn-mini btn-success form-btn" ng-click=new() ng-disabled=isNewDisabled()><i class=icon-plus></i> New</button> <button id=deleteButton class="btn btn-mini btn-danger form-btn" ng-click=delete() ng-disabled=isDeleteDisabled()><i class=icon-minus></i> Delete</button></div>'),a.put("template/form-button-bs3.html",'<div class="btn-group pull-right"><button id=saveButton class="btn btn-primary form-btn btn-xs" ng-click=save() ng-disabled=isSaveDisabled()><i class="glyphicon glyphicon-ok"></i> Save</button> <button id=cancelButton class="btn btn-warning form-btn btn-xs" ng-click=cancel() ng-disabled=isCancelDisabled()><i class="glyphicon glyphicon-remove"></i> Cancel</button></div><div class="btn-group pull-right"><button id=newButton class="btn btn-success form-btn btn-xs" ng-click=new() ng-disabled=isNewDisabled()><i class="glyphicon glyphicon-plus"></i> New</button> <button id=deleteButton class="btn btn-danger form-btn btn-xs" ng-click=delete() ng-disabled=isDeleteDisabled()><i class="glyphicon glyphicon-minus"></i> Delete</button></div>'),a.put("template/search-bs2.html",'<form class="navbar-search pull-right"><div id=search-cg class=control-group ng-class=errorClass><input id=searchinput ng-model=searchTarget class=search-query placeholder="Ctrl+Slash to Search" ng-keyup=handleKey($event)></div></form><div class=results-container ng-show="results.length >= 1"><div class=search-results><div ng-repeat="result in results"><span ng-class=resultClass($index) ng-click=selectResult($index)>{{result.resourceText}} {{result.text}}</span></div><div ng-show="moreCount > 0">(plus more - continue typing to narrow down search...)</div></div></div>'),a.put("template/search-bs3.html",'<form class="pull-right navbar-form"><div id=search-cg class=form-group ng-class=errorClass><input id=searchinput ng-model=searchTarget class="search-query form-control" placeholder="Ctrl+Slash to Search" ng-keyup=handleKey($event)></div></form><div class=results-container ng-show="results.length >= 1"><div class=search-results><div ng-repeat="result in results"><span ng-class=resultClass($index) ng-click=selectResult($index)>{{result.resourceText}} {{result.text}}</span></div><div ng-show="moreCount > 0">(plus more - continue typing to narrow down search...)</div></div></div>')}]),formsAngular.factory("$locationParse",[function(){var a=null,b={};return function(c){if(c!==a){a=c;var d=c.split("/"),e=d.length;if(2===e&&"index"===d[1])b={index:!0};else if(b={newRecord:!1},"analyse"===d[1])b.analyse=!0,b.modelName=d[2];else{b.modelName=d[1];var f=d[e-1];"new"===f?(b.newRecord=!0,e--):"edit"===f&&(e-=2,b.id=d[e]),e>2&&(b.formName=d[2])}}return b}}]),formsAngular.factory("$data",[function(){var a={record:{},disableFunctions:{},dataEventFunctions:{}};return a}]),formsAngular.provider("urlService",["$locationProvider",function(a){var b={hashPrefix:"",html5Mode:!1};return{setOptions:function(c){angular.extend(b,c),a.html5Mode(b.html5Mode),""!==b.hashPrefix&&a.hashPrefix(b.hashPrefix)},$get:function(){return{buildUrl:function(a){var c=b.html5Mode?"":"#";return c+=b.hashPrefix,c[0]&&(c+="/"),c+a}}}}}]),formsAngular.provider("formRoutes",["$routeProvider",function(a){return{setRoutes:function(b,c){for(var d=0;d<b.length;d++)a.when(b[d].route,b[d].options);a.when("/analyse/:model/:reportSchemaName",{templateUrl:"partials/base-analysis.html"}).when("/analyse/:model",{templateUrl:"partials/base-analysis.html"}).when("/:model/:id/edit",{templateUrl:"partials/base-edit.html"}).when("/:model/new",{templateUrl:"partials/base-edit.html"}).when("/:model",{templateUrl:"partials/base-list.html"}).when("/:model/:form/:id/edit",{templateUrl:"partials/base-edit.html"}).when("/:model/:form/new",{templateUrl:"partials/base-edit.html"}).when("/:model/:form",{templateUrl:"partials/base-list.html"}).otherwise({redirectTo:c})},$get:function(){return null}}}]),formsAngular.service("utils",function(){function a(a,b,c,d){function e(a){for(var b in a)b===c&&i.push(a[b]),"$parent"===b&&e(a[b])}var f,g,h,i=[],j=[];if(c="addAll"+c,"string"==typeof d)for(f=d.split(" "),g=0;g<f.length;g++)j.push(f[g]);if(e(a),void 0!==b[c])if("object"==typeof b[c]);else if("string"==typeof b[c])for(f=b[c].split(" "),g=0;g<f.length;g++)0===f[g].indexOf("class=")?j.push(f[g].substring(6,f[g].length)):i.push(f[g]);return d=j.length>0?' class="'+j.join(" ")+'" ':" ",h=i.length>0?i.join(" ")+" ":"",d+h}this.getAddAllGroupOptions=function(b,c,d){return a(b,c,"Group",d)},this.getAddAllFieldOptions=function(b,c,d){return a(b,c,"Field",d)},this.getAddAllLabelOptions=function(b,c,d){return a(b,c,"Label",d)}}),formsAngular.provider("cssFrameworkService",[function(){var a={framework:"bs2"};return{setOptions:function(b){angular.extend(a,b)},$get:function(){return{framework:function(){return a.framework},span:function(b){var c;switch(a.framework){case"bs2":c="span"+b;break;case"bs3":c="col-xs-"+b}return c},offset:function(b){var c;switch(a.framework){case"bs2":c="offset"+b;break;case"bs3":c="col-lg-offset-"+b}return c},rowFluid:function(){var b;switch(a.framework){case"bs2":b="row-fluid";break;case"bs3":b="row"}return b}}}}}]),formsAngular.controller("BaseCtrl",["$scope","$routeParams","$location","$http","$filter","$data","$locationParse","$modal","$window","urlService",function(a,b,c,d,e,f,g,h,i,j){function k(a,b,c){var d="#"+(c?"cg_":"")+b;a?$(d).removeClass(s):$(d).addClass(s)}function l(){var c="?l="+a.pageSize,d=function(a,b){b&&""!==b&&(c+="&"+a+"="+b)};return d("f",b.f),d("a",b.a),d("o",b.o),d("s",a.pagesLoaded*a.pageSize),a.pagesLoaded++,c}function m(a){var b=a.split("."),c=[b[0]];return b.length>1&&c.push(b.slice(1).join(".")),c}function n(a,b,c){var d=m(a);if(d.length>1)o(d[1],b[d[0]],c);else if(b[d[0]]){var e=b[d[0]];b[d[0]]=c(e)}}function o(a,b,c){if(void 0!==b)if($.isArray(b))for(var d=0;d<b.length;d++)n(a,b[d],c);else n(a,b,c)}function p(a,b,c,d){if(a.array){for(var e=[],f=0;f<b.length;f++)e.push({x:H(b[f],d,c,a.name)});return e}return a.select2?{id:b,text:H(b,d,c,a.name)}:H(b,d,c,a.name)}function q(a,b,c,d){if(a.array){for(var e=[],f=0;f<b.length;f++)e.push(I(b[f],c,d,a.name));return e}return I(b,c,d,a.name)}var r={},s="fng-invalid-required",t=f,u=!0;t.baseScope=a,a.record=t.record,a.phase="init",a.disableFunctions=t.disableFunctions,a.dataEventFunctions=t.dataEventFunctions,a.topLevelFormName=void 0,a.formSchema=[],a.tabs=[],a.listSchema=[],a.recordList=[],a.dataDependencies={},a.select2List=[],a.pageSize=20,a.pagesLoaded=0,angular.extend(a,g(c.$$path)),a.formPlusSlash=a.formName?a.formName+"/":"",a.modelNameDisplay=t.modelNameDisplay||e("titleCase")(a.modelName),a.generateEditUrl=function(b){return j.buildUrl(a.modelName+"/"+a.formPlusSlash+b._id+"/edit")},a.walkTree=function(a,b,c){for(var d=b.split("."),e=d.length-1,f=a,g=0;e>g&&(f=f[d[g]],angular.isArray(f)&&(f=f[c.scope().$index]),f);g++);return{lastObject:f,key:f?d[e]:void 0}},a.getData=function(b,c,d){var e=a.walkTree(b,c,d);return e.lastObject&&e.key?e.lastObject[e.key]:void 0},a.setData=function(b,c,d,e){var f=a.walkTree(b,c,d);f.lastObject[f.key]=e};var v=function(a,b){return(a.id||"f_"+a.name).replace(/\./g,"_")+b},w=function(b,e,f){var g;if(e.caster&&(b.array=!0,e=e.caster,$.extend(f,e.options)),"String"===e.instance)f.enum?(b.type=b.type||"select",f.required&&(a.$watch("record."+b.name,function(a){k(a,b.id,b.select2)},!0),setTimeout(function(){k(a.record[b.name],b.id,b.select2)},0)),b.select2?(a["select2"+b.name]={allowClear:!f.required,initSelection:function(a,b){b(a.select2("data"))},query:function(a){for(var b={results:[]},c=a.term.toUpperCase(),d=0;d<f.enum.length;d++)-1!==f.enum[d].toUpperCase().indexOf(c)&&b.results.push({id:d,text:f.enum[d]});a.callback(b)}},_.extend(a["select2"+b.name],b.select2),b.select2.s2query="select2"+b.name,a.select2List.push(b.name)):(b.options=v(b,"Options"),a[b.options]=f.enum)):(b.type||(b.type=-1!==b.name.toLowerCase().indexOf("password")?"password":"text"),f.match&&(b.add='pattern="'+f.match+'" '+(b.add||"")));else if("ObjectID"===e.instance)b.ref=f.ref,b.link&&b.link.linkOnly?(b.type="link",b.linkText=b.link.text,b.form=b.link.form,delete b.link):(b.type="select",b.select2?(a.select2List.push(b.name),b.select2.fngAjax?(g="ajax"+b.name.replace(/\./g,""),a[g]={allowClear:!f.required,minimumInputLength:2,initSelection:function(e,g){var h=e.val();h&&""!==h&&d.get("/api/"+f.ref+"/"+h+"/list").success(function(d){d.success===!1&&c.path("/404");var f={id:h,text:d.list};a.setData(r,b.name,e,f);var i=e.inheritedData("$ngModelController"),j=i.$pristine;j&&(i.$pristine=!1),g(f),j&&(i.$pristine=!0)}).error(function(){c.path("/404")})},ajax:{url:"/api/search/"+f.ref,data:function(a,b){return{q:a,pageLimit:10,page:b}},results:function(a){return{results:a.results,more:a.moreCount>0}}}},_.extend(a[g],b.select2),b.select2.fngAjax=g):(b.select2===!0&&(b.select2={}),a["select2"+b.name]={allowClear:!f.required,initSelection:function(c,d){var e=c.val();if(""!==e&&a[b.ids].length>0){var f=H(e,a[b.ids],a[b.options],b.name),g={id:e,text:f};d(g)}},query:function(c){for(var d={results:[]},e=c.term.toUpperCase(),f=0;f<a[b.options].length;f++)-1!==a[b.options][f].toUpperCase().indexOf(e)&&d.results.push({id:a[b.ids][f],text:a[b.options][f]});c.callback(d)}},_.extend(a["select2"+b.name],b.select2),b.select2.s2query="select2"+b.name,a.select2List.push(b.name),b.options=v(b,"Options"),b.ids=v(b,"_ids"),J(f.ref,b))):(b.options=v(b,"Options"),b.ids=v(b,"_ids"),J(f.ref,b)));else if("Date"===e.instance)b.type||(b.readonly?b.type="text":(b.type="text",b.add="ui-date ui-date-format "));else if("boolean"===e.instance)b.type="checkbox";else{if("Number"!==e.instance)throw new Error("Field "+b.name+" is of unsupported type "+e.instance);b.type="number",f.min&&(b.add='min="'+f.min+'" '+(b.add||"")),f.max&&(b.add='max="'+f.max+'" '+(b.add||"")),b.step&&(b.add='step="'+b.step+'" '+(b.add||""))}return f.required&&(b.required=!0),f.readonly&&(b.readonly=!0),b},x=function(a,b,c){return b.name=c+a,b},y=function(a,b,c){var d=b||{hidden:!0};d.hidden||("object"==typeof d?(d.name=c,a.push(d)):a.push({name:c}))},z=function(a,b,c,d){if(c){for(var e=0,f=c.length;f>e;e++)if("text"===c[e].type){b.push({name:c[e].name});break}0===b.length&&0!==c.length&&b.push({name:c[0].name})}if(0===b.length){for(var g in d)if("_id"!==g&&d.hasOwnProperty(g)){b.push({name:g});break}if(0===b.length)throw new Error("Unable to generate a title for "+a)}},A=function(b,c){function d(b){var d=b;if("string"==typeof b&&"$"===b.slice(0,1)){var e=b.split(".");switch(e.length){case 1:d=a.getListData(c,b.slice(1));break;case 2:d=a.getListData(c,e[1]);break;default:throw new Error("Unsupported showIf format")}}return d}var e,f=d(b.lhs),g=d(b.rhs);switch(b.comp){case"eq":e=f===g;break;case"ne":e=f!==g;break;default:throw new Error("Unsupported comparator "+b.comp)}return e},B=function(b,c){function d(b){if("string"==typeof b&&"$"===b.slice(0,1)){var d=b.slice(1),f=a.dataDependencies[d]||[];f.push(c),a.dataDependencies[d]=f,e+=1}}var e=0,f=!0;return b&&(d(b.lhs),d(b.rhs),0!==e||A(b)||(f=!1)),f};a.getListData=function(b,c){for(var d=c.split("."),e=0;e<d.length;e++)void 0!==b&&(b=b[d[e]]);return b&&-1!==a.select2List.indexOf(d[e-1])&&(b=b.text),void 0===b&&(b=""),b},a.updateDataDependentDisplay=function(b,c,d){var e,f,g,h,i,j;for(var k in a.dataDependencies)if(a.dataDependencies.hasOwnProperty(k)){var l=k.split(".");if(1===l.length){if(d||!c||b[k]!==c[k])for(e=a.dataDependencies[k],f=0;f<e.length;f+=1){var m=e[f];for(g=0;g<a.formSchema.length;g+=1)a.formSchema[g].name===m&&(i=angular.element("#cg_"+a.formSchema[g].id),A(a.formSchema[g].showIf,b)?i.removeClass("ng-hide"):i.addClass("ng-hide"))}}else{if(2!==l.length)throw new Error("You can only go down one level of subdocument with showIf");if(void 0===j&&(j=!0),b[l[0]])for(h=0;h<b[l[0]].length;h++)if(d||!c||!c[l[0]]||!c[l[0]][h]||b[l[0]][h][l[1]]!==c[l[0]][h][l[1]])for(e=a.dataDependencies[k],f=0;f<e.length;f+=1){var n=e[f].split(".");if(2!==n.length)throw new Error("Conditional display must control dependent fields at same level ");for(g=0;g<a.formSchema.length;g+=1)if(a.formSchema[g].name===n[0])for(var o=a.formSchema[g].schema,p=0;p<o.length;p++)o[p].name===e[f]&&(i=angular.element("#f_"+n[0]+"List_"+h+" #cg_f_"+e[f].replace(".","_")),0===i.length?i=angular.element("#f_elements-"+h+"-"+n[1]):j=!1,i.length>0&&(A(a.formSchema[g].schema[p].showIf,b[l[0]][h])?i.show():i.hide()))}}}return j};var C=function(b,c,d,e,f,g){function h(b,c){var d=angular.copy(b),e=_.find(a.tabs,function(a){return a.title===d});if(!e){if(0===a.tabs.length&&a.formSchema.length>0){a.tabs.push({title:"Main",content:[]}),e=a.tabs[0];for(var f=0;f<a.formSchema.length;f++)e.content.push(a.formSchema[f])}e=a.tabs[a.tabs.push({title:d,containerType:"tab",content:[]})-1]}e.content.push(c)}for(var i in c)if("_id"!==i&&c.hasOwnProperty(i)){var j=c[i],k=j.options||{},l=k.form||{};if(!l.hidden)if(j.schema){if(g&&d){var m=[];C("Nested "+i,j.schema,m,null,i+".",!0);var n=x(i,l,f);n.schema=m,l.tab&&h(l.tab,n),void 0!==l.order?d.splice(l.order,0,n):d.push(n)}}else{if(d){var o=x(i,l,f);if(B(o.showIf,o.name)&&"options"!==i){var p=w(o,j,k);p.tab&&h(p.tab,p),void 0!==l.order?d.splice(l.order,0,p):d.push(p)}}e&&y(e,k.list,i)}}e&&0===e.length&&z(b,e,d,c)};a.processServerData=function(b){r=F(a.formSchema,b,0),a.phase="ready",a.cancel()},a.readRecord=function(){d.get("/api/"+a.modelName+"/"+a.id).success(function(b){b.success===!1&&c.path("/404"),u=!1,a.phase="reading","function"==typeof a.dataEventFunctions.onAfterRead&&a.dataEventFunctions.onAfterRead(b),a.processServerData(b)}).error(function(){c.path("/404")})},a.scrollTheList=function(){d.get("/api/"+a.modelName+l()).success(function(b){angular.isArray(b)?a.recordList=a.recordList.concat(b):a.showError(b,"Invalid query")}).error(function(){c.path("/404")})},d.get("/api/schema/"+a.modelName+(a.formName?"/"+a.formName:""),{cache:!0}).success(function(b){if(C("Main "+a.modelName,b,a.formSchema,a.listSchema,"",!0),a.id||a.newRecord){var c=!0;a.$watch("record",function(b,d){b!==d&&(c=a.updateDataDependentDisplay(b,d,c))},!0),a.id?"function"==typeof a.dataEventFunctions.onBeforeRead?a.dataEventFunctions.onBeforeRead(a.id,function(b){b?a.showError(b):a.readRecord()}):a.readRecord():(r={},a.phase="ready",a.cancel())}else u=!0}).error(function(){c.path("/404")}),a.setPristine=function(){a.dismissError(),a[a.topLevelFormName]&&a[a.topLevelFormName].$setPristine()},a.cancel=function(){for(var b in a.record)a.record.hasOwnProperty(b)&&delete a.record[b];$.extend(!0,a.record,r),a.setPristine()},a.$on("showErrorMessage",function(b,c){a.showError(c.body,c.title)});var D=function(b,c){if(-1!==[200,400].indexOf(c)){var d="";for(var f in b.errors)if(b.errors.hasOwnProperty(f)){switch(d+="<li><b>"+e("titleCase")(f)+": </b> ",b.errors[f].type){case"enum":d+="You need to select from the list of values";break;default:d+=b.errors[f].message}d+="</li>"}d=d.length>0?b.message+"<br /><ul>"+d+"</ul>":b.message||"Error!  Sorry - No further details available.",a.showError(d)}else a.showError(c+" "+JSON.stringify(b))};a.showError=function(b,c){a.alertTitle=c?c:"Error!",a.errorMessage=b},a.dismissError=function(){delete a.errorMessage},a.createNew=function(b,e){d.post("/api/"+a.modelName,b).success(function(b){b.success!==!1?("function"==typeof a.dataEventFunctions.onAfterCreate&&a.dataEventFunctions.onAfterCreate(b),e.redirect?i.location=e.redirect:c.path("/"+a.modelName+"/"+a.formPlusSlash+b._id+"/edit")):a.showError(b)}).error(D)},a.updateDocument=function(b,c){a.phase="updating",d.post("/api/"+a.modelName+"/"+a.id,b).success(function(b){b.success!==!1?("function"==typeof a.dataEventFunctions.onAfterUpdate&&a.dataEventFunctions.onAfterUpdate(b,r),c.redirect?(c.allowChange&&(u=!0),i.location=c.redirect):(a.processServerData(b),a.setPristine())):a.showError(b)}).error(D)},a.save=function(b){b=b||{};var c=G(a.formSchema,angular.copy(a.record),0);a.id?"function"==typeof a.dataEventFunctions.onBeforeUpdate?a.dataEventFunctions.onBeforeUpdate(c,r,function(d){d?a.showError(d):a.updateDocument(c,b)}):a.updateDocument(c,b):"function"==typeof a.dataEventFunctions.onBeforeCreate?a.dataEventFunctions.onBeforeCreate(c,function(d){d?a.showError(d):a.createNew(c,b)}):a.createNew(c,b)},a.new=function(){c.search(""),c.path("/"+a.modelName+"/"+a.formPlusSlash+"new")},a.deleteRecord=function(b,e){d.delete("/api/"+b+"/"+e).success(function(){"function"==typeof a.dataEventFunctions.onAfterDelete&&a.dataEventFunctions.onAfterDelete(r),c.path("/"+a.modelName)})},a.$on("$locationChangeStart",function(b,c){if(!u&&!a.isCancelDisabled()){b.preventDefault();var d=h.open({template:'<div class="modal-header">   <h3>Record modified</h3></div><div class="modal-body">   <p>Would you like to save your changes?</p></div><div class="modal-footer">    <button class="btn btn-primary dlg-yes" ng-click="yes()">Yes</button>    <button class="btn btn-warning dlg-no" ng-click="no()">No</button>    <button class="btn dlg-cancel" ng-click="cancel()">Cancel</button></div>',controller:"SaveChangesModalCtrl",backdrop:"static"});d.result.then(function(b){b?a.save({redirect:c,allowChange:!0}):(u=!0,i.location=c)})}}),a.delete=function(){if(a.record._id){var b=h.open({template:'<div class="modal-header">   <h3>Delete Item</h3></div><div class="modal-body">   <p>Are you sure you want to delete this record?</p></div><div class="modal-footer">    <button class="btn btn-primary dlg-no" ng-click="cancel()">No</button>    <button class="btn btn-warning dlg-yes" ng-click="yes()">Yes</button></div>',controller:"SaveChangesModalCtrl",backdrop:"static"});b.result.then(function(b){b&&("function"==typeof a.dataEventFunctions.onBeforeDelete?a.dataEventFunctions.onBeforeDelete(r,function(b){b?a.showError(b):a.deleteRecord(a.modelName,a.id)}):a.deleteRecord(a.modelName,a.id))})}},a.isCancelDisabled=function(){return"function"==typeof a.disableFunctions.isCancelDisabled?a.disableFunctions.isCancelDisabled(a.record,r,a[a.topLevelFormName]):a[a.topLevelFormName]&&a[a.topLevelFormName].$pristine},a.isSaveDisabled=function(){return"function"==typeof a.disableFunctions.isSaveDisabled?a.disableFunctions.isSaveDisabled(a.record,r,a[a.topLevelFormName]):a[a.topLevelFormName]&&(a[a.topLevelFormName].$invalid||a[a.topLevelFormName].$pristine)},a.isDeleteDisabled=function(){return"function"==typeof a.disableFunctions.isDeleteDisabled?a.disableFunctions.isDeleteDisabled(a.record,r,a[a.topLevelFormName]):!a.id},a.isNewDisabled=function(){return"function"==typeof a.disableFunctions.isNewDisabled?a.disableFunctions.isNewDisabled(a.record,r,a[a.topLevelFormName]):!1},a.disabledText=function(b){var c="";return a.isSaveDisabled&&(c="This button is only enabled when the form is complete and valid.  Make sure all required inputs are filled in. "+b),c},a.skipCols=function(a){return a>0?"col-md-offset-2":""},a.setFormDirty=function(a){if(a){var b=angular.element(a.target).inheritedData("$formController");b.$setDirty()}else console.log("setFormDirty called without an event (fine in a unit test)")},a.add=function(b,c){var d,e=b.split(".");d=a.record;for(var f=0,g=e.length;g>f;f++)d[e[f]]||(d[e[f]]=f===g-1?[]:{}),d=d[e[f]];d.push({}),a.setFormDirty(c)},a.remove=function(b,c,d){for(var e=b.split("."),f=a.record,g=0,h=e.length;h>g;g++)f=f[e[g]];f.splice(c,1),a.setFormDirty(d)};var E=function(a){var b=!1;return"text"===a.type?b=!0:"select"!==a.type||a.ids||(b=!0),b},F=function(b,c,d){for(var e=0;e<b.length;e++){var f=b[e].name.slice(d);if(b[e].schema){if(c[f])for(var g=0;g<c[f].length;g++)c[f][g]=F(b[e].schema,c[f][g],d+1+f.length)}else{var h=a.getListData(c,f);if(b[e].array&&E(b[e])&&h)for(var i=0;i<h.length;i++)h[i]={x:h[i]};var j=a[v(b[e],"_ids")];j&&j.length>0&&c[f]?c[f]=p(b[e],c[f],a[v(b[e],"Options")],j):b[e].select2&&!b[e].select2.fngAjax&&c[f]&&a[b[e].select2.s2query].query({term:c[f],callback:function(a){a.results.length>0&&(c[f]=a.results[0])}})}}return c},G=function(b,c,d){for(var e=0;e<b.length;e++){var f=b[e].name.slice(d),g=a.getListData(c,f);if(b[e].schema){if(g)for(var h=0;h<g.length;h++)g[h]=G(b[e].schema,g[h],d+1+f.length)}else{if(b[e].array&&E(b[e])&&g)for(var i=0;i<g.length;i++)g[i]=g[i].x;var j=a[v(b[e],"_ids")];if(j&&j.length>0)n(f,c,function(c){return q(b[e],c,a[v(b[e],"Options")],j)});else if(b[e].select2){var k=a.getData(c,f,null);b[e].select2.fngAjax?k&&k.id&&a.setData(c,f,null,k.id):k?a.setData(c,f,null,k.text):a.setData(c,f,null,void 0)}}}return c},H=function(a,b,c,d){var e=b.indexOf(a);if(-1===e)throw new Error("convertIdToListValue: Invalid data - id "+a+" not found in "+b+" processing "+d);return c[e]},I=function(a,b,c,d){var e=_.isObject(a)?a.x||a.text:a;if(e&&e.match(/^[0-9a-f]{24}$/))return e;var f=b.indexOf(e);if(-1===f)throw new Error("convertListValueToId: Invalid data - value "+e+" not found in "+b+" processing "+d);return c[f]},J=function(b,c){var e=a[c.options]=[],f=a[c.ids]=[];d.get("/api/schema/"+b,{cache:!0}).success(function(a){var g=[];C("Lookup "+b,a,null,g,"",!1),d.get("/api/"+b,{cache:!0}).success(function(a){if(a){for(var b=0;b<a.length;b++){for(var d="",h=0;h<g.length;h++)d+=a[b][g[h].name]+" ";d=d.trim();var i=_.sortedIndex(e,d);e[i]===d&&(d=d+"    ("+a[b]._id+")",i=_.sortedIndex(e,d)),e.splice(i,0,d),f.splice(i,0,a[b]._id)}K(c)}})})},K=function(b){(!a.topLevelFormName||a[a.topLevelFormName].$pristine)&&(n(b.name,r,function(c){return p(b,c,a[v(b,"Options")],a[v(b,"_ids")])}),r[b.name]&&(a.record[b.name]=r[b.name]))};a.openSelect2=function(a){$("#"+$(a.currentTarget).data("select2-open")).select2("open")},a.toJSON=function(a){return JSON.stringify(a,null,2)},a.baseSchema=function(){return a.tabs.length?a.tabs:a.formSchema}}]).controller("SaveChangesModalCtrl",["$scope","$modalInstance",function(a,b){a.yes=function(){b.close(!0)},a.no=function(){b.close(!1)},a.cancel=function(){b.dismiss("cancel")}}]),formsAngular.controller("AnalysisCtrl",["$locationParse","$filter","$scope","$http","$location","$routeParams","urlService",function(a,b,c,d,e,f,g){var h=!0,i=new ngGridPdfExportPlugin({inhibitButton:!0}),j=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(c,f),c.reportSchema={},c.gridOptions={columnDefs:"reportSchema.columnDefs",data:"report",showColumnMenu:!0,showFilter:!0,showFooter:!0,reallyShowFooter:!0,showTotals:!0,enableColumnResize:!0,footerRowHeight:65,multiSelect:!1,plugins:[i,j],afterSelectionChange:function(a){var b=c.reportSchema.drilldown;b&&(b=g.buildUrl(b.replace(/\|.+?\|/g,function(b){var d=b.slice(1,-1),e=/\((.+)\)/.exec(d);return e?c.reportSchema.params[e[1]].value:a.entity[d]})),window.location=b)},footerTemplate:'<div ng-show="gridOptions.reallyShowFooter" class="ngFooterPanel" ng-class="{\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}" ng-style="footerStyle()"><div ng-show="gridOptions.showTotals" ng-style="{height: rowHeight+3}"><div ng-style="{ \'cursor\': row.cursor }" ng-repeat="col in renderedColumns" ng-class="col.colIndex()" class="ngCell ngTotalCell {{col.cellClass}}"><div class="ngVerticalBar" ng-style="{height: rowHeight}" ng-class="{ ngVerticalBarVisible: !$last }">&nbsp;</div><div ng-total-cell></div> </div></div><div class="ngTotalSelectContainer" ><div class="ngFooterTotalItems" ng-class="{\'ngNoMultiSelect\': !multiSelect}" ><span class="ngLabel">{{i18n.ngTotalItemsLabel}} {{maxRows()}}</span><span ng-show="filterText.length > 0" class="ngLabel">({{i18n.ngShowingItemsLabel}} {{totalFilteredItemsLength()}})</span></div><div class="ngFooterSelectedItems" ng-show="multiSelect">  <span class="ngLabel">{{i18n.ngSelectedItemsLabel}} {{selectedItems.length}}</span></div></div><div class="ngPagerContainer" style="float: right; margin-top: 10px;" ng-show="enablePaging" ng-class="{\'ngNoMultiSelect\': !multiSelect}"><div style="float:left; margin-right: 10px;" class="ngRowCountPicker"><span style="float: left; margin-top: 3px;" class="ngLabel">{{i18n.ngPageSizeLabel}}</span><select style="float: left;height: 27px; width: 100px" ng-model="pagingOptions.pageSize" ><option ng-repeat="size in pagingOptions.pageSizes">{{size}}</option></select></div><div style="float:left; margin-right: 10px; line-height:25px;" class="ngPagerControl" style="float: left; min-width: 135px;"><button class="ngPagerButton" ng-click="pageToFirst()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerFirstTitle}}"><div class="ngPagerFirstTriangle"><div class="ngPagerFirstBar"></div></div></button><button class="ngPagerButton" ng-click="pageBackward()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerPrevTitle}}"><div class="ngPagerFirstTriangle ngPagerPrevTriangle"></div></button><input class="ngPagerCurrent" min="1" max="{{maxPages()}}" type="number" style="width:50px; height: 24px; margin-top: 1px; padding: 0 4px;" ng-model="pagingOptions.currentPage"/><button class="ngPagerButton" ng-click="pageForward()" ng-disabled="cantPageForward()" title="{{i18n.ngPagerNextTitle}}"><div class="ngPagerLastTriangle ngPagerNextTriangle"></div></button><button class="ngPagerButton" ng-click="pageToLast()" ng-disabled="cantPageToLast()" title="{{i18n.ngPagerLastTitle}}"><div class="ngPagerLastTriangle"><div class="ngPagerLastBar"></div></div></button></div></div></div>'},c.report=[],!c.reportSchemaName&&f.r)switch(f.r.slice(0,1)){case"[":c.reportSchema.pipeline=JSON.parse(f.r);break;case"{":angular.extend(c.reportSchema,JSON.parse(f.r));break;default:throw new Error("No report instructions specified")}c.getTotalVal=function(a,d){var e="",f=_.find(c.reportSchema.columnDefs,function(b){return b.field===a});if(f)switch(f.totalsRow){case void 0:break;case"$SUM":for(var g=0,h=0;h<c.report.length;h++)g+=c.report[h][a];e=g,d&&(e=b(d)(e));break;default:e=f.totalsRow}return e},c.$on("exportToPDF",function(){i.createPDF()}),c.$on("exportToCSV",function(){j.createCSV()}),c.refreshQuery=function(){var a="/api/report/"+c.model,f="?";if(c.reportSchemaName&&(a+="/"+c.reportSchemaName),c.paramSchema){for(var g in c.record)if(c.record.hasOwnProperty(g)){var i=c.reportSchema.params[g];if(c.record[g]&&""!==c.record[g])c.param=c.record[g],i.conversionExpression&&(c.param=c.$eval(i.conversionExpression)),a+=f+g+"="+c.param,f="&";else if(i.required)return}}else{var j=e.$$url.match(/\?.*/);j&&(a+=f+j[0].slice(1))}d.get(a).success(function(a){if(a.success){if(c.report=a.report,c.reportSchema=a.schema,c.reportSchema.title=c.reportSchema.title||c.model,h&&(h=!1,c.$watch("reportSchema.columnDefs",function(a){var b=!1;if(a)for(var d=0;d<a.length;d++)if(a[d].totalsRow&&(b=!0),a[d].align){var e="fng-"+a[d].align;a[d].cellClass=a[d].cellClass||"",-1===a[d].cellClass.indexOf(e)&&(a[d].cellClass=a[d].cellClass+" "+e)}c.gridOptions.showTotals=b,c.gridOptions.reallyShowFooter=b,c.gridOptions.footerRowHeight=55+(b?10:0)},!0),!c.paramSchema&&a.schema.params)){c.paramSchema=[],c.record={};for(var d in a.schema.params)if(a.schema.params.hasOwnProperty(d)){var e=a.schema.params[d];if(!e.noInput){var f=c.paramSchema.push({name:d,id:"fp_"+d,label:e.label||b("titleCase")(d),type:e.type||"text",required:!0,add:e.add||void 0,size:e.size||"small"});"select"===e.type&&(c[d+"_Opts"]=e.enum,c.paramSchema[f-1].options=d+"_Opts")}var g=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})(Z|[+ -]\d{4})$/.exec(e.value);g&&(e.value=moment(g[1]).format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z"),c.record[d]=e.value}c.$watch("record",function(a,b){b!==a&&c.refreshQuery()},!0)}}else console.log(JSON.stringify(a)),c.reportSchema.title="Error - see console log"}).error(function(a){console.log(JSON.stringify(a)),e.path("/404")})},c.refreshQuery()}]),formsAngular.controller("ModelCtrl",["$scope","$http","$location","urlService",function(a,b,c,d){a.models=[],b.get("/api/models").success(function(b){a.models=b}).error(function(){c.path("/404")}),a.newUrl=function(a){return d.buildUrl(a+"/new")},a.listUrl=function(a){return d.buildUrl(a)}}]),formsAngular.controller("NavCtrl",["$scope","$data","$location","$filter","$locationParse","$controller","urlService","cssFrameworkService",function(a,b,c,d,e,f,g,h){function i(b,c){var d,e={};b+="Ctrl",e.$scope=a.scopes[c]=a.$new();try{f(b,e),d=a.routing.newRecord?"creating":a.routing.id?"editing":"listing",angular.isObject(e.$scope.contextMenu)&&angular.forEach(e.$scope.contextMenu,function(b){b[d]&&a.items.push(b)})}catch(g){/is not a function, got undefined/.test(g.message)||console.log("Unable to instantiate "+b+" - "+g.message)}}a.items=[],a.globalShortcuts=function(a){if(191===a.keyCode&&a.ctrlKey){var b=angular.element.find("input")[0];b&&"searchinput"===angular.element(b).attr("id")&&(angular.element(b).focus(),a.preventDefault())}},a.css=function(a,b){var c;return c="function"==typeof h[a]?h[a](b):"error text-error"},a.$on("$locationChangeSuccess",function(){if(a.routing=e(c.$$path),a.items=[],a.routing.analyse)a.contextMenu="Report",a.items=[{broadcast:"exportToPDF",text:"PDF"},{broadcast:"exportToCSV",text:"CSV"}];else if(a.routing.modelName){angular.forEach(a.scopes,function(a){a.$destroy()
}),a.scopes=[],b.record={},b.disableFunctions={},b.dataEventFunctions={},delete b.dropDownDisplay,delete b.modelNameDisplay;var f=d("titleCase")(a.routing.modelName,!0);i(f,0),a.routing.formName&&i(f+d("titleCase")(a.routing.formName,!0),1),a.contextMenu=b.dropDownDisplay||b.modelNameDisplay||d("titleCase")(a.routing.modelName,!1)}}),a.doClick=function(b){if(a.items[b].broadcast)a.$broadcast(a.items[b].broadcast);else{var c=a.items[b].args||[],d=a.items[b].fn;switch(c.length){case 0:d();break;case 1:d(c[0]);break;case 2:d(c[0],c[1]);break;case 3:d(c[0],c[1],c[2]);break;case 4:d(c[0],c[1],c[2],c[3])}}},a.isHidden=function(b){return a.items[b].isHidden?a.items[b].isHidden():!1},a.buildUrl=function(a){return g.buildUrl(a)}}]),formsAngular.directive("formInput",["$compile","$rootScope","utils","$filter","urlService","cssFrameworkService",function(a,b,c,d,e,f){return{restrict:"EA",link:function(g,h,i){function j(a,b,d){var e="getAddAll"+a+"Options";return c[e](g,d,b)||[]}var k=[1,2,4,6,8,10,12],l=["mini","small","medium","large","xlarge","xxlarge","block-level"],m=2,n=[],o=!1,p=function(a){return!a||"undefined"===a||-1===["vertical","inline"].indexOf(a)},q=function(a,b){function c(a){var c=a;if("string"==typeof a)if("$"===a.slice(0,1)){c=(b||"record")+".";var d=a.slice(1).split(".");if(d.length>1){var e=d.pop();c+=d.join(".")+"[$index]."+e}else c+=a.slice(1)}else c="'"+a+"'";return c}var d=["eq","ne","gt","gte","lt","lte"],e=["===","!==",">",">=","<","<="],f=d.indexOf(a.comp);if(-1===f)throw new Error("Invalid comparison in showWhen");return c(a.lhs)+e[f]+c(a.rhs)},r=function(a,b,c){var d="<input "+a+'type="'+c.type+'"';return"inline"!==b.formstyle||"bs2"!==f.framework()||c.size||(d+='class="input-small"'),d+=" />"},s=function(a,b,c,d,g){var h;if(!b)if(b=(g.model||"record")+".",g.subschema&&-1!==a.name.indexOf(".")){var i=a.name,n=i.lastIndexOf("."),o=i.slice(n+1);if(g.index){var q=b.length;b+=i.slice(0,n)+"."+g.index+"."+o,d="f_"+b.slice(q).replace(/\./g,"-")}else b+=i.slice(0,n),g.subkey?(b+="[$_arrayOffset_"+i.slice(0,n).replace(/\./g,"_")+"_"+g.subkeyno+"]."+o,d=i+"_subkey"):(b+="[$index]."+o,d=null,h=i.replace(/\./g,"-"))}else b+=a.name;var s,t=c||a.required?" required":"",u=a.readonly?" readonly":"",v=a.placeHolder,w="",x="",y="",z="";"bs3"===f.framework()?(w=-1===["horizontal","vertical","inline"].indexOf(g.formstyle)?" input-sm":"",x="col-xs-"+k[a.size?l.indexOf(a.size):m],z=" form-control"):y=a.size?" input-"+a.size:"","inline"===g.formstyle&&(v=v||a.label);var A='ng-model="'+b+'"'+(d?' id="'+d+'" name="'+d+'" ':' name="'+h+'" ');switch(A+=v?'placeholder="'+v+'" ':"",a.popup&&(A+='title="'+a.popup+'" '),A+=j("Field",null,g),a.type){case"select":A+=a.readonly?"disabled ":"",a.select2?(A+='class="fng-select2'+z+w+y+'"',a.select2.fngAjax?"bs2"===f.framework()?(s='<div class="input-append">',s+='<input ui-select2="'+a.select2.fngAjax+'" '+A+">",s+='<button class="btn" type="button" data-select2-open="'+d+'" ng-click="openSelect2($event)"><i class="icon-search"></i></button>',s+="</div>"):(s='<div class="input-group">',s+='<input ui-select2="'+a.select2.fngAjax+'" '+A+">",s+='<span class="input-group-addon'+w+'" data-select2-open="'+d+'" ',s+='    ng-click="openSelect2($event)"><i class="glyphicon glyphicon-search"></i></span>',s+="</div>"):a.select2&&(s='<input ui-select2="'+a.select2.s2query+'" '+(a.readonly?"disabled ":"")+A+">")):(s="<select "+A+'class="'+z.trim()+w+y+'">',c||(s+="<option></option>"),angular.isArray(a.options)?angular.forEach(a.options,function(a){s+="<option>"+a+"</option>"}):s+='<option ng-repeat="option in '+a.options+'">{{option}}</option>',s+="</select>");break;case"link":s='<a ng-href="/'+e.buildUrl("")+a.ref+(a.form?"/"+a.form:"")+"/{{ "+b+'}}/edit">'+a.linkText+"</a>";break;case"radio":s="";var B="inline"!==g.formstyle&&!a.inlineRadio;if(angular.isArray(a.options))angular.forEach(a.options,function(a){s+="<input "+A+'type="radio"',s+=' value="'+a+'">'+a,B&&(s+="<br />")});else{var C=B?"div":"span";s+="<"+C+' ng-repeat="option in '+a.options+'"><input '+A+' type="radio" value="{{option}}"> {{option}} </'+C+"> "}break;case"checkbox":s="bs3"===f.framework()?'<div class="checkbox"><input '+A+'type="checkbox"></div>':r(A,g,a);break;default:A+='class="'+z.trim()+w+y+'"'+(a.add?a.add:""),A+='ng-model="'+b+'"'+(d?' id="'+d+'" name="'+d+'"':"")+t+u+" ","textarea"===a.type?(a.rows&&(A+="auto"===a.rows?'msd-elastic="\n" class="ng-animate" ':'rows = "'+a.rows+'" '),"ckEditor"===a.editor&&(A+='ckeditor = "" ',"bs3"===f.framework()&&(x="col-xs-12")),s="<textarea "+A+" />"):s=r(A,g,a)}return"bs3"===f.framework()&&p(g.formstyle)&&"checkbox"!==a.type&&(s='<div class="'+x+'">'+s+"</div>"),a.helpInline&&"checkbox"!==a.type&&(s+='<span class="help-inline">'+a.helpInline+"</span>"),a.help&&(s+='<span class="help-block '+x+'">'+a.help+"</span>"),s},t=function(a){var b;switch(a){case"horizontal":b="form-horizontal";break;case"vertical":b="";break;case"inline":b="form-inline";break;case"horizontalCompact":b="form-horizontal compact";break;default:b="form-horizontal compact"}return b},u=function(a){var b={before:"",after:""};if("function"==typeof a.containerType)b=a.containerType(a);else switch(a.containerType){case"tab":b.before='<tab heading="'+a.title+'">',b.after="</tab>";break;case"tabset":b.before="<tabset>",b.after="</tabset>";break;case"well":b.before='<div class="well">',a.title&&(b.before+="<h4>"+a.title+"</h4>"),b.after="</div>";break;case"well-large":b.before='<div class="well well-lg well-large">',b.after="</div>";break;case"well-small":b.before='<div class="well well-sm well-small">',b.after="</div>";break;case"fieldset":b.before="<fieldset>",a.title&&(b.before+="<legend>"+a.title+"</legend>"),b.after="</fieldset>";break;case void 0:break;case null:break;case"":break;default:if(b.before='<div class="'+a.containerType+'">',a.title){var c=a.titleTagOrClass||"h4";b.before+=c.match(/h[1-6]/)?"<"+c+">"+a.title+"</"+a.titleLook+">":'<p class="'+c+'">'+a.title+"</p>"}b.after="</div>"}return b},v=function(a,b,c){var d="";return("inline"!==c.formstyle&&(""!==a.label||"bs3"===f.framework())||b)&&(d="<label",p(c.formstyle)&&(d+=' for="'+a.id+'"',"bs3"===f.framework()&&(d+=j("Label","col-sm-2",c))),d+=j("Label","control-label",c),d+=">"+a.label+(b||"")+"</label>"),d},w=function(a,b){a.type=a.type||"text",a.id=a.id||"f_"+a.name.replace(/\./g,"_"),a.label=void 0!==a.label?null===a.label?"":a.label:d("titleCase")(a.name.split(".").slice(-1)[0]);var c="",e="",h="";"bs3"===f.framework()?(h="form-group","vertical"===b.formstyle&&"block-level"!==a.size&&(c+='<div class="row">',h+=" col-xs-"+k[a.size?l.indexOf(a.size):m],e+="</div>"),c+="<div"+j("Group",h,b),e+="</div>"):p(b.formstyle)?(c+="<div"+j("Group","control-group",b),e="</div>"):(c+="<span ",e="</span>");var o=!1;if(b.index)try{parseInt(b.index),o=!0}catch(r){}if(a.showWhen&&(c+="string"==typeof a.showWhen?'ng-show="'+a.showWhen+'"':'ng-show="'+q(a.showWhen,b.model)+'"'),c+=o?' id="cg_'+a.id.replace("_","-"+i.index+"-")+'">':' id="cg_'+a.id.replace(/\./g,"-")+'">',a.schema){var w=a.name.replace(/\./g,"_"),y="$_schema_"+w;if(g[y]=a.schema,a.schema)if(a.subkey){a.subkey.path=a.name,g[y+"_subkey"]=a.subkey;for(var z=angular.isArray(a.subkey)?a.subkey:[a.subkey],A=0;A<z.length;A++){var B=u(z[A]);c+=B.before,c+=x(a.schema,null,{subschema:!0,formStyle:b.formstyle,subkey:y+"_subkey",subkeyno:A}),c+=B.after}n.push(a)}else c+='<div class="schema-head">'+a.label+'</div><div ng-form class="'+("bs2"===f.framework()?"row-fluid ":"")+t(a.formStyle)+'" name="form_'+w+'{{$index}}" class="sub-doc well" id="'+a.id+'List_{{$index}}"  ng-repeat="subDoc in '+(b.model||"record")+"."+a.name+' track by $index">   <div class="'+("bs2"===f.framework()?"row-fluid":"row")+' sub-doc">      <div class="pull-left">'+x(a.schema,!1,{subschema:!0,formstyle:a.formStyle,model:b.model})+"      </div>",(!a.noRemove||a.customSubDoc)&&(c+='   <div class="pull-left sub-doc-btns">',a.customSubDoc&&(c+=a.customSubDoc),a.noRemove||(c+="bs2"===f.framework()?'      <button name="remove_'+a.id+'_btn" class="remove-btn btn btn-mini form-btn" ng-click="remove(\''+a.name+'\',$index,$event)">          <i class="icon-minus">':'      <button name="remove_'+a.id+'_btn" class="remove-btn btn btn-default btn-xs form-btn" ng-click="remove(\''+a.name+'\',$index,$event)">          <i class="glyphicon glyphicon-minus">',c+="          </i> Remove      </button>"),c+="  </div> "),c+="   </div></div>",(!a.noAdd||a.customFooter)&&(c+='<div class = "schema-foot">',a.customFooter&&(c+=a.customFooter),a.noAdd||(c+="bs2"===f.framework()?'    <button id="add_'+a.id+'_btn" class="add-btn btn btn-mini form-btn" ng-click="add(\''+a.name+'\',$event)">        <i class="icon-plus"></i> Add':'    <button id="add_'+a.id+'_btn" class="add-btn btn btn-default btn-xs form-btn" ng-click="add(\''+a.name+'\',$event)">        <i class="glyphicon glyphicon-plus"></i> Add',c+="    </button>"),c+="</div>")}else{var C=[];if(p(b.formstyle)&&C.push("bs2"===f.framework()?"controls":"col-sm-10"),a.array){if(C.push("fng-array"),"inline"===b.formstyle)throw"Cannot use arrays in an inline form";c+="bs2"===f.framework()?v(a,' <i id="add_'+a.id+'" ng-click="add(\''+a.name+'\',$event)" class="icon-plus-sign"></i>',b)+'<div class="'+C.join(" ")+'" id="'+a.id+'List" ng-repeat="arrayItem in '+(b.model||"record")+"."+a.name+'">'+s(a,"arrayItem.x",!0,a.id+"_{{$index}}",b)+"<i ng-click=\"remove('"+a.name+'\',$index,$event)" id="remove_'+a.id+'_{{$index}}" class="icon-minus-sign"></i></div>':v(a,' <i id="add_'+a.id+'" ng-click="add(\''+a.name+'\',$event)" class="glyphicon glyphicon-plus-sign"></i>',b)+'<div ng-class="skipCols($index)" class="'+C.join(" ")+'" id="'+a.id+'List" ng-repeat="arrayItem in '+(b.model||"record")+"."+a.name+'">'+s(a,"arrayItem.x",!0,a.id+"_{{$index}}",b)+"<i ng-click=\"remove('"+a.name+'\',$index,$event)" id="remove_'+a.id+'_{{$index}}" class="glyphicon glyphicon-minus-sign"></i></div>'}else c+=v(a,null,b),C.length>0&&(c+='<div class="'+C.join(" ")+'">'),c+=s(a,null,b.required,a.id,b),C.length>0&&(c+="</div>")}return c+=e},x=function(a,b,c){var d="";if(a)for(var e=0;e<a.length;e++){var f=a[e];0===e&&b&&!c.schema.match(/$_schema_/)&&(f.add=f.add||"",-1!==f.add.indexOf("ui-date")||c.noautofocus||f.containerType||(f.add=f.add+"autofocus "));var i=!0;if(f.directive){for(var j=f.directive,k="<"+j+' model="'+(c.model||"record")+'"',l=h[0],m=0;m<l.attributes.length;m++){var n=l.attributes[m];switch(n.nodeName){case"class":var p=n.nodeValue.replace("ng-scope","");p.length>0&&(k+=' class="'+p+'"');break;case"schema":var q=("bespoke_"+f.name).replace(/\./g,"_");g[q]=angular.copy(f),delete g[q].directive,k+=' schema="'+q+'"';break;default:k+=" "+n.nodeName+'="'+n.nodeValue+'"'}}k+="></"+j+">",d+=k,i=!1}else if(f.containerType){var r=u(f);switch(f.containerType){case"tab":o||(o="forced",d+="<tabset>"),d+=r.before,d+=x(f.content,null,c),d+=r.after;break;case"tabset":o=!0,d+=r.before,d+=x(f.content,null,c),d+=r.after;break;default:d+=r.before,d+=x(f.content,null,c),d+=r.after}i=!1}else if(c.subkey){var s=angular.isArray(g[c.subkey])?g[c.subkey][0].keyList:g[c.subkey].keyList;_.find(s,function(a,b){return g[c.subkey].path+"."+b===f.name})&&(i=!1)}i&&(d+=w(f,c))}else console.log("Empty array passed to processInstructions"),d="";return d},y=g.$watch(i.schema,function(c){if(c&&(c=angular.isArray(c)?c:[c],c.length>0)){y();var d="",e=g[i.model||"record"];if(!i.subschema&&!i.model||i.forceform){g.topLevelFormName=i.name||"myForm";var f="";for(var j in i)i.hasOwnProperty(j)&&"$"!==j[0]&&-1===["name","formstyle","schema","subschema","model"].indexOf(j)&&(f+=" "+i.$attr[j]+'="'+i[j]+'"');d='<form name="'+g.topLevelFormName+'" class="'+t(i.formstyle)+' novalidate"'+f+">"}else d="";if(e===g.topLevelFormName)throw new Error("Model and Name must be distinct - they are both "+e);if(d+=x(c,!0,i),"forced"===o&&(d+="</tabset>"),d+=i.subschema?"":"</form>",h.replaceWith(a(d)(g)),n.length>0)var k=g.$watch("phase",function(a){if("ready"===a){k();for(var b=0;b<n.length;b++)for(var c,d,f=n[b],h=angular.isArray(f.subkey)?f.subkey:[f.subkey],i=0;i<h.length;i++){var j=h[i].keyList,l=e[f.name]=e[f.name]||[];for(c=0;c<l.length;c++){d=!0;for(var m in j)if(j.hasOwnProperty(m)&&l[c][m]!==j[m]){d=!1;break}if(d)break}d||(c=e[f.name].push(j)-1),g["$_arrayOffset_"+f.name.replace(/\./g,"_")+"_"+i]=c}}});b.$broadcast("formInputDone"),g.updateDataDependentDisplay&&e&&Object.keys(e).length>0&&g.updateDataDependentDisplay(e,null,!0)}},!0)}}}]),formsAngular.directive("formButtons",["cssFrameworkService",function(a){return{restrict:"A",templateUrl:"template/form-button-"+a.framework()+".html"}}]),formsAngular.controller("SearchCtrl",["$scope","$http","$location",function(a,b,c){var d="";a.handleKey=function(b){if(27===b.keyCode&&a.searchTarget.length>0)a.searchTarget="";else if(a.results.length>0)switch(b.keyCode){case 38:a.focus>0&&a.setFocus(a.focus-1),"function"==typeof b.preventDefault&&b.preventDefault();break;case 40:a.results.length>a.focus+1&&a.setFocus(a.focus+1),"function"==typeof b.preventDefault&&b.preventDefault();break;case 13:null!=a.focus&&a.selectResult(a.focus)}},a.setFocus=function(b){null!==a.focus&&delete a.results[a.focus].focussed,a.results[b].focussed=!0,a.focus=b},a.selectResult=function(b){var d=a.results[b];c.path("/"+d.resource+"/"+d.id+"/edit")},a.resultClass=function(b){var c="search-result";return a.results&&a.results[b].focussed&&(c+=" focus"),c};var e=function(){a.moreCount=0,a.errorClass="",a.results=[],a.focus=null};a.$watch("searchTarget",function(c){c&&c.length>0?(d=c,b.get("/api/search?q="+c).success(function(b){d===c&&(a.searchTarget.length>0?(a.results=b.results,a.moreCount=b.moreCount,b.results.length>0&&(a.errorClass="",a.setFocus(0)),a.errorClass=0===a.results.length?"error":""):e())}).error(function(a,b){console.log("Error in searchbox.js : "+a+" (status="+b+")")})):e()},!0),a.$on("$routeChangeStart",function(){a.searchTarget=""})}]).directive("globalSearch",["cssFrameworkService",function(a){return{restrict:"AE",templateUrl:"template/search-"+a.framework()+".html",controller:"SearchCtrl"}}]);var COL_FIELD=/COL_FIELD/g;formsAngular.directive("ngTotalCell",["$compile","$domUtilityService",function(a,b){var c={scope:!1,compile:function(){return{pre:function(b,c){var d,e,f=b.col.cellTemplate.match(/{{COL_FIELD \|(.+)}}/);e=f?b.col.cellTemplate.replace("COL_FIELD |"+f[1],'getTotalVal("'+b.col.field+'","'+f[1]+'")'):b.col.cellTemplate.replace(COL_FIELD,'getTotalVal("'+b.col.field+'")'),b.col.enableCellEdit?(d=b.col.cellEditTemplate,d=d.replace(DISPLAY_CELL_TEMPLATE,e),d=d.replace(EDITABLE_CELL_TEMPLATE,b.col.editableCellTemplate.replace(COL_FIELD,"row.entity."+b.col.field))):d=e;var g=a(d)(b);b.enableCellSelection&&-1===g[0].className.indexOf("ngSelectionCell")&&(g[0].setAttribute("tabindex",0),g.addClass("ngCellElement")),c.append(g)},post:function(a,c){a.enableCellSelection&&a.domAccessProvider.selectionHandlers(a,c),a.$on("ngGridEventDigestCell",function(){b.digest(a)})}}}};return c}]),function(a){var b,c,d,e,f=3,g=13,h={x:void 0,y:void 0,w:void 0,h:void 0,ln:void 0},i=1,j=function(a,b,c,d,e){h={x:a,y:b,w:c,h:d,ln:e}},k=function(){return h};a.setHeaderFunction=function(a){e=a},a.getTextDimensions=function(a){b=this.internal.getFont().fontName,c=this.table_font_size||this.internal.getFontSize(),d=this.internal.getFont().fontStyle;var e,f,g=19.049976/25.4;return f=document.createElement("font"),f.id="jsPDFCell",f.style.fontStyle=d,f.style.fontName=b,f.style.fontSize=c+"pt",f.innerText=a,document.body.appendChild(f),e={w:(f.offsetWidth+1)*g,h:(f.offsetHeight+1)*g},document.body.removeChild(f),e},a.cellAddPage=function(){this.addPage(),j(this.margins.left,this.margins.top,void 0,void 0),i+=1},a.cellInitialize=function(){h={x:void 0,y:void 0,w:void 0,h:void 0,ln:void 0},i=1},a.cell=function(a,b,c,d,e,h,i){var l=k();if(void 0!==l.ln&&(l.ln===h?(a=l.x+l.w,b=l.y):(l.y+l.h+d+g>=this.internal.pageSize.height-this.margins.bottom&&(this.cellAddPage(),this.printHeaders&&this.tableHeaderRow&&this.printHeaderRow(h,!0)),b=k().y+k().h)),void 0!==e[0])if(this.printingHeaderRow?this.rect(a,b,c,d,"FD"):this.rect(a,b,c,d),"right"===i){var m;if(e instanceof Array)for(var n=0;n<e.length;n++){var o=e[n];m=this.getStringUnitWidth(o)*this.internal.getFontSize()/2.8125,this.text(o,a+c-m-f,b+this.internal.getLineHeight()*(n+1))}else m=this.getStringUnitWidth(e)*this.internal.getFontSize()/2.8125,this.text(e,a+c-m-f,b+this.internal.getLineHeight())}else this.text(e,a+f,b+this.internal.getLineHeight());return j(a,b,c,d,h),this},a.getKeys="function"==typeof Object.keys?function(a){return a?Object.keys(a):[]}:function(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push(b);return c},a.arrayMax=function(a,b){var c,d,e,f=a[0];for(c=0,d=a.length;d>c;c+=1)e=a[c],b?-1===b(f,e)&&(f=e):e>f&&(f=e);return f},a.table=function(b,c,d,e){if(!d)throw"No data for PDF table";var f,g,j,k,l,m,n,o,p,q,r=[],s=[],t={},u={},v=[],w=[],x=[],y=!1,z=!0,A=12,B=null,C=null,D={left:0,top:0,bottom:0,width:this.internal.pageSize.width};if(e&&(e.autoSize===!0&&(y=!0),e.printHeaders===!1&&(z=!1),e.fontSize&&(A=e.fontSize),e.margins&&(D=e.margins),e.headers&&(B=e.headers),e.footers&&(C=e.footers)),this.lnMod=0,h={x:void 0,y:void 0,w:void 0,h:void 0,ln:void 0},i=1,this.printHeaders=z,this.margins=D,this.setFontSize(A),this.table_font_size=A,void 0===B||null===B)r=this.getKeys(d[0]);else if(B[0]&&"string"!=typeof B[0]){var E=1.5;for(g=0,j=B.length;j>g;g+=1)f=B[g],r.push(f.name),s.push(f.prompt),u[f.name]=f.width*E,w[f.name]=f.align}else r=B;if(y)for(q=function(a){return a[f]},g=0,j=r.length;j>g;g+=1){for(f=r[g],t[f]=d.map(q),v.push(this.getTextDimensions(s[g]||f).w),m=t[f],n=0,k=m.length;k>n;n+=1)l=m[n],v.push(this.getTextDimensions(l).w);C&&v.push(this.getTextDimensions(C[g]).w),u[f]=a.arrayMax(v)}if(z){var F=this.calculateLineHeight(r,u,s.length?s:r);for(g=0,j=r.length;j>g;g+=1)f=r[g],x.push([b,c,u[f],F,String(s.length?s[g]:f),0,w[f]]);this.setTableHeaderRow(x),this.printHeaderRow(1,!1)}for(g=0,j=d.length;j>g;g+=1){var F;for(o=d[g],F=this.calculateLineHeight(r,u,o),n=0,p=r.length;p>n;n+=1)f=r[n],this.cell(b,c,u[f],F,o[f],g+2,w[f])}if(C){for(var G=0;G<r.length;G++)f=r[G],x[G][4]=C[f]||" ";this.printHeaderRow(g+2,!1)}return this.table_x=b,this.table_y=c,this},a.calculateLineHeight=function(a,b,c){for(var d,e=0,g=0;g<a.length;g++){d=a[g],c[d]=this.splitTextToSize(String(c[d]),b[d]-f);var h=this.internal.getLineHeight()*c[d].length+f;h>e&&(e=h)}return e},a.setTableHeaderRow=function(a){this.tableHeaderRow=a},a.printHeaderRow=function(a,b){if(!this.tableHeaderRow)throw"Property tableHeaderRow does not exist.";var c,d,f,g;if(this.printingHeaderRow=!0,void 0!==e){var h=e(this,i);j(h[0],h[1],h[2],h[3],-1)}this.setFontStyle("bold");var k=[];for(f=0,g=this.tableHeaderRow.length;g>f;f+=1)this.setFillColor(200,200,200),c=this.tableHeaderRow[f],b&&(c[1]=this.margins.top,k.push(c)),d=[].concat(c),d[5]=a,this.cell.apply(this,d);k.length>0&&this.setTableHeaderRow(k),this.setFontStyle("normal"),this.printingHeaderRow=!1}}(jsPDF.API),formsAngular.filter("titleCase",[function(){return function(a,b){var c=a.replace(/(_|\.)/g," ").replace(/[A-Z]/g," $&").trim().replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()});return c=b?c.replace(/\s/g,""):c.replace(/\s{2,}/g," ")}}]);